<div class="container my-5 py-5 is-loading">
    <h1 class="display-4 fw-bold text-center mb-5"><%= pageTitle %></h1>

    <div class="skeleton-loader">
        <div class="skeleton-grid">
            <% for(let i = 0; i < 8; i++) { %>
                <div class="skeleton-card">
                    <div class="skeleton skeleton-image"></div>
                    <div class="skeleton-body">
                        <div class="skeleton skeleton-line"></div>
                        <div class="skeleton skeleton-line short"></div>
                    </div>
                </div>
            <% } %>
        </div>
    </div>
    
    <div class="content-to-load">
        <% if (products && products.length > 0) { %>
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-4 g-4">
                <% products.forEach(product => { %>
                    <div class="col">
                        <div class="product-card" data-sku="<%= product.sku %>">
                            <div class="product-card-img-container">
                                <a href="/products/<%= product.sku %>" class="product-card-img-link"></a>
                                <img src="<%= product.thumbnailUrl %>" class="product-card-img" alt="<%= product.name %>" loading="lazy" width="300" height="300">
                                <div class="product-card-actions">
                                    <% if (currentUser) { %>
                                        <button type="button" class="btn-action wishlist-toggle-btn" title="Toggle Wishlist" data-product-id="<%= product._id %>">
                                            <% const isWishlisted = wishlist.some(id => id.equals(product._id)); %>
                                            <i class="bi <%= isWishlisted ? 'bi-heart-fill' : 'bi-heart' %>"></i>
                                        </button>
                                    <% } else { %>
                                        <a href="/users/login?redirect=<%= path %>" class="btn-action" title="Login to Add to Wishlist">
                                            <i class="bi bi-heart"></i>
                                        </a>
                                    <% } %>
                                    <button type="button" class="btn-action" title="Add to Cart" data-bs-toggle="modal" data-bs-target="#productModal-<%= product.sku %>">
                                        <i class="bi bi-bag-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="product-card-body">
                                <a href="/products/<%= product.sku %>" class="text-decoration-none">
                                    <div class="product-title"><%= product.name %></div>
                                    <div class="product-price">
                                        <% if (product.onSale) { %>
                                            <span class="fw-bold text-dark"><%= locationData.symbol %><%= product.convertedSalePrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                                            <del class="text-body-secondary ms-2"><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></del>
                                            <span class="text-success fw-bold ms-2"><%= product.discountPercentage %>% OFF</span>
                                        <% } else { %>
                                            <span><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                                        <% } %>
                                    </div>
                                </a>
                            </div>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } else { %>
            <div class="text-center p-5 bg-light rounded-4">
                <h3 class="text-body-secondary">No products found.</h3>
                <p class="lead text-body-secondary">Try adjusting your search or filter to find what you're looking for.</p>
            </div>
        <% } %>
    </div>
</div>


<% if (products && products.length > 0) { %>
    <% products.forEach(product => { %>
        <% 
            const standardSizes = ['8', '8.5', '9', '9.5', '10', '10.5', '11', '12'];
        %>
        <div class="modal fade quick-add-modal" id="productModal-<%= product.sku %>" tabindex="-1" aria-labelledby="productModalLabel-<%= product.sku %>" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <% if (product.brand.toLowerCase() === 'adidas') { %>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/2/20/Adidas_Logo.svg" alt="Adidas" class="brand-logo">
                        <% } else if (product.brand.toLowerCase() === 'jordan') { %>
                             <img src="https://upload.wikimedia.org/wikipedia/en/thumb/3/37/Jumpman_logo.svg/1200px-Jumpman_logo.svg.png" alt="Jordan" class="brand-logo">
                        <% } else if (product.brand.toLowerCase() === 'new balance') { %>
                             <img src="https://logos-world.net/wp-content/uploads/2020/09/New-Balance-Emblem-700x394.png" alt="New Balance" class="brand-logo">
                        <% } else { %>
                            <img src="https://upload.wikimedia.org/wikipedia/commons/a/a6/Logo_NIKE.svg" alt="Nike" class="brand-logo">
                        <% } %>
                        <i class="bi bi-x-lg action-icon" data-bs-dismiss="modal" aria-label="Close"></i>
                    </div>
                    <div class="modal-body">
                        <div class="product-image-wrapper">
                            <img src="<%= product.thumbnailUrl %>" alt="<%= product.name %>" class="product-image" loading="lazy" width="300" height="300">
                        </div>
                        <div class="product-details-wrapper">
                            <div class="product-info">
                                <h2><%= product.name %></h2>
                                <p class="sku">SKU: <%= product.sku %></p>
                                <div class="price-and-rating">
                                    <div class="price mb-0 d-flex flex-wrap align-items-center">
                                        <% if (product.onSale) { %>
                                            <span class="fw-bold text-dark me-2"><%= locationData.symbol %><%= product.convertedSalePrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                                            <del class="text-body-secondary small me-2"><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></del>
                                            <span class="text-success fw-bold"><%= product.discountPercentage %>% OFF</span>
                                        <% } else { %>
                                            <span class="fw-bold text-dark"><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                                        <% } %>
                                    </div>
                                    <div class="rating">
                                        <% 
                                            const averageRating = product.averageRating || 0; 
                                            const fullStars = Math.floor(averageRating);
                                            const halfStar = averageRating % 1 >= 0.5 ? 1 : 0;
                                            const emptyStars = 5 - fullStars - halfStar;
                                        %>
                                        <% if (averageRating > 0) { %>
                                            <% for(let i = 0; i < fullStars; i++) { %><i class="bi bi-star-fill"></i><% } %>
                                            <% if (halfStar) { %><i class="bi bi-star-half"></i><% } %>
                                            <% for(let i = 0; i < emptyStars; i++) { %><i class="bi bi-star"></i><% } %>
                                        <% } else { %>
                                            <small class="text-body-secondary">No reviews</small>
                                        <% } %>
                                    </div>
                                </div>
                            </div>

                            <form action="/cart/add" method="POST" id="form-add-<%= product.sku %>" class="mt-3">
                                <input type="hidden" name="productId" value="<%= product._id %>">
                                <input type="hidden" name="sku" value="<%= product.sku %>">
                                <div>
                                    <div class="size-selection-header">
                                        <i class="bi bi-rulers"></i>
                                        <span>Select Size</span>
                                    </div>
                                    <div class="size-selector">
                                        <% standardSizes.forEach(size => { %>
                                            <% 
                                                const safeSizeKey = size.replace('.', '_');
                                                const isSizeAvailable = product.stock && product.stock[safeSizeKey] > 0;
                                            %>
                                            <input type="radio" class="btn-check" name="size" id="modal-size-<%= product.sku %>-<%= size %>" value="<%= size %>" autocomplete="off" required <%= !isSizeAvailable ? 'disabled' : '' %>>
                                            <label class="btn btn-outline-secondary <%= !isSizeAvailable ? 'disabled' : '' %>" for="modal-size-<%= product.sku %>-<%= size %>"><%= size %></label>
                                        <% }) %>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" form="form-add-<%= product.sku %>" class="btn btn-primary btn-lg w-100 add-to-cart-btn">Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>
    <% }) %>
<% } %>