<div class="container my-5 pt-4">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-center mb-4">
        <div>
            <h1 class="display-4 fw-bolder text-uppercase mb-0" style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; letter-spacing: -1px;">
                <%= pageTitle === 'Shop All' ? 'THE COLLECTION' : pageTitle %>
            </h1>
            <p class="text-secondary small mt-1 mb-0" id="result-count"><%= products ? products.length : 0 %> results</p>
        </div>
        
        <div class="d-none d-md-block">
            <select class="form-select border-0 bg-light rounded-pill px-4" style="font-weight: 500;" id="desktop-sort" onchange="applyFilters()">
                <option value="date-desc" <%= (!filters.sort || filters.sort === 'date-desc') ? 'selected' : '' %>>Newest First</option>
                <option value="price-asc" <%= filters.sort === 'price-asc' ? 'selected' : '' %>>Price: Low - High</option>
                <option value="price-desc" <%= filters.sort === 'price-desc' ? 'selected' : '' %>>Price: High - Low</option>
            </select>
        </div>
    </div>

    <div class="d-flex flex-wrap gap-2 mb-5 align-items-center brand-scroll-container">
        <a href="/products" class="btn btn-pill <%= !filters.brand ? 'btn-dark' : 'btn-light text-secondary' %> fw-bold px-4 rounded-pill">All</a>
        <% 
            const popularBrands = ['Nike', 'Adidas', 'Jordan', 'New Balance']; 
            popularBrands.forEach(brand => {
                const isActive = filters.brand === brand;
        %>
            <a href="/products?brand=<%= brand %>" class="btn btn-pill <%= isActive ? 'btn-dark' : 'btn-light text-secondary' %> fw-bold px-4 rounded-pill">
                <%= brand %>
            </a>
        <% }) %>
        
        <button class="btn btn-outline-dark rounded-pill px-4 ms-auto d-md-none" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterOffcanvas">
            <i class="bi bi-sliders"></i> Filters
        </button>
    </div>

    <div class="row">
        <div class="col-lg-3 d-none d-lg-block">
            <div class="sticky-top" style="top: 100px; z-index: 1;">
                <form id="desktopFilterForm" onsubmit="return false;">
                    <% if(filters.category) { %><input type="hidden" name="category" value="<%= filters.category %>"><% } %>
                    <% if(filters.brand) { %><input type="hidden" name="brand" value="<%= filters.brand %>"><% } %>

                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold text-uppercase small mb-0">Price</h6>
                            <button type="button" class="btn btn-link p-0 text-decoration-none text-secondary small" onclick="clearPrice()">Reset</button>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control bg-light border-0" id="minPrice" name="minPrice" placeholder="0" value="<%= filters.minPrice %>" oninput="debounceFilter()">
                                    <label for="minPrice" class="text-secondary small">Min (<%= locationData.symbol %>)</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-floating">
                                    <input type="number" class="form-control bg-light border-0" id="maxPrice" name="maxPrice" placeholder="1000" value="<%= filters.maxPrice %>" oninput="debounceFilter()">
                                    <label for="maxPrice" class="text-secondary small">Max (<%= locationData.symbol %>)</label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <hr class="text-secondary opacity-25 my-4">

                    <div class="mb-4">
                        <h6 class="fw-bold text-uppercase small mb-3">Size (US)</h6>
                        <div class="size-grid">
                            <% ['8', '8.5', '9', '9.5', '10', '10.5', '11', '12'].forEach(size => { 
                                const isChecked = filters.sizes && filters.sizes.includes(size);
                            %>
                                <div class="size-item">
                                    <input type="checkbox" class="btn-check size-filter-input" name="sizes" id="size-<%= size %>" value="<%= size %>" <%= isChecked ? 'checked' : '' %> onchange="applyFilters()">
                                    <label class="btn btn-outline-secondary w-100 py-2 fw-medium rounded-2 border-0 bg-light text-dark" for="size-<%= size %>"><%= size %></label>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                    
                    <% if (Object.keys(filters).some(k => filters[k])) { %>
                        <a href="/products" class="btn btn-link text-secondary w-100 text-decoration-none small mt-3">Clear All Filters</a>
                    <% } %>
                </form>
            </div>
        </div>

        <div class="col-lg-9" id="product-grid-container">
            <% if (products && products.length > 0) { %>
                <div class="row row-cols-2 row-cols-sm-2 row-cols-lg-3 g-3 g-md-4">
                    <% products.forEach(product => { %>
                        <div class="col">
                            <div class="product-card" data-sku="<%= product.sku %>">
                                <div class="product-card-img-container">
                                    <a href="/products/<%= product.sku %>" class="product-card-img-link"></a>
                                    <img src="<%= product.thumbnailUrl %>" class="product-card-img" alt="<%= product.name %>" loading="lazy" width="300" height="300">
                                    <div class="product-card-actions">
                                        <% if (currentUser) { %>
                                            <button type="button" class="btn-action wishlist-toggle-btn" title="Toggle Wishlist" data-product-id="<%= product._id %>">
                                                <% const isWishlisted = wishlist.some(id => id.equals(product._id)); %>
                                                <i class="bi <%= isWishlisted ? 'bi-heart-fill' : 'bi-heart' %>"></i>
                                            </button>
                                        <% } else { %>
                                            <a href="/users/login?redirect=<%= path %>" class="btn-action" title="Login to Add to Wishlist">
                                                <i class="bi bi-heart"></i>
                                            </a>
                                        <% } %>
                                        <button type="button" class="btn-action" title="Add to Cart" data-bs-toggle="modal" data-bs-target="#productModal-<%= product.sku %>">
                                            <i class="bi bi-bag-plus"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="product-card-body">
                                    <a href="/products/<%= product.sku %>" class="text-decoration-none">
                                        <div class="product-title"><%= product.name %></div>
                                        <div class="product-price">
                                            <% if (product.onSale) { %>
                                                <span class="fw-bold text-dark"><%= locationData.symbol %><%= product.convertedSalePrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                                                <del class="text-body-secondary ms-2"><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></del>
                                                <span class="text-success fw-bold ms-2"><%= product.discountPercentage %>% OFF</span>
                                            <% } else { %>
                                                <span><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                                            <% } %>
                                        </div>
                                    </a>
                                </div>
                            </div>
                            </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="text-center py-5 mt-5">
                    <h4 class="fw-light text-secondary mb-3">No products found matching your criteria.</h4>
                    <a href="/products" class="text-dark fw-bold text-decoration-underline">Clear Filters</a>
                </div>
            <% } %>
        </div>
    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="filterOffcanvas" aria-labelledby="filterOffcanvasLabel">
    <div class="offcanvas-header">
        <h5 class="offcanvas-title fw-bold" id="filterOffcanvasLabel">Filters</h5>
        <button type="button" class="btn-close text-reset" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
        <form action="/products" method="GET">
            <% if(filters.category) { %><input type="hidden" name="category" value="<%= filters.category %>"><% } %>
            <% if(filters.brand) { %><input type="hidden" name="brand" value="<%= filters.brand %>"><% } %>

            <div class="mb-4 pb-4 border-bottom">
                <h6 class="fw-bold text-uppercase small mb-3">Sort By</h6>
                <select class="form-select bg-light border-0" name="sort">
                    <option value="date-desc" <%= (!filters.sort || filters.sort === 'date-desc') ? 'selected' : '' %>>Newest First</option>
                    <option value="price-asc" <%= filters.sort === 'price-asc' ? 'selected' : '' %>>Price: Low - High</option>
                    <option value="price-desc" <%= filters.sort === 'price-desc' ? 'selected' : '' %>>Price: High - Low</option>
                </select>
            </div>

            <div class="mb-4">
                <h6 class="fw-bold text-uppercase small mb-3">Price Range</h6>
                <div class="d-flex align-items-center gap-2">
                    <input type="number" name="minPrice" class="form-control" placeholder="Min" value="<%= filters.minPrice %>">
                    <span>-</span>
                    <input type="number" name="maxPrice" class="form-control" placeholder="Max" value="<%= filters.maxPrice %>">
                </div>
            </div>

            <div class="mb-4">
                <h6 class="fw-bold text-uppercase small mb-3">Size</h6>
                <div class="d-flex flex-wrap gap-2">
                    <% ['8', '8.5', '9', '9.5', '10', '10.5', '11', '12'].forEach(size => { %>
                        <input type="checkbox" class="btn-check" name="sizes" id="mobile-size-<%= size %>" value="<%= size %>" <%= (filters.sizes && filters.sizes.includes(size)) ? 'checked' : '' %>>
                        <label class="btn btn-outline-secondary" for="mobile-size-<%= size %>"><%= size %></label>
                    <% }) %>
                </div>
            </div>

            <button type="submit" class="btn btn-dark w-100 py-3 rounded-pill">View Results</button>
        </form>
    </div>
</div>

<% if (products && products.length > 0) { %>
    <% products.forEach(product => { %>
        <% const standardSizes = ['8', '8.5', '9', '9.5', '10', '10.5', '11', '12']; %>
        <div class="modal fade quick-add-modal" id="productModal-<%= product.sku %>" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content rounded-4 border-0 overflow-hidden">
                    <div class="modal-header border-0 pb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body pt-0">
                        <div class="text-center mb-4">
                            <img src="<%= product.thumbnailUrl %>" alt="<%= product.name %>" class="img-fluid" style="max-height: 250px; object-fit: contain;">
                        </div>
                        <h4 class="fw-bold"><%= product.name %></h4>
                        <div class="d-flex align-items-center gap-2 mb-3">
                            <% if (product.onSale) { %>
                                <span class="fs-5 fw-bold"><%= locationData.symbol %><%= product.convertedSalePrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                                <del class="text-secondary"><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></del>
                            <% } else { %>
                                <span class="fs-5 fw-bold"><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                            <% } %>
                        </div>

                        <form action="/cart/add" method="POST" id="form-add-<%= product.sku %>">
                            <input type="hidden" name="productId" value="<%= product._id %>">
                            <input type="hidden" name="sku" value="<%= product.sku %>">
                            <p class="small fw-bold text-uppercase text-secondary mb-2">Select Size</p>
                            <div class="d-flex flex-wrap gap-2 mb-4">
                                <% standardSizes.forEach(size => { 
                                    const safeSizeKey = size.replace('.', '_');
                                    const isSizeAvailable = product.stock && product.stock[safeSizeKey] > 0;
                                %>
                                    <input type="radio" class="btn-check" name="size" id="modal-size-<%= product.sku %>-<%= size %>" value="<%= size %>" autocomplete="off" required <%= !isSizeAvailable ? 'disabled' : '' %>>
                                    <label class="btn btn-outline-dark rounded-0 px-3 <%= !isSizeAvailable ? 'opacity-25' : '' %>" for="modal-size-<%= product.sku %>-<%= size %>"><%= size %></label>
                                <% }) %>
                            </div>
                            <button type="submit" class="btn btn-dark w-100 py-3 rounded-pill fw-bold">Add to Cart</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    <% }) %>
<% } %>

<style>
    .btn-pill {
        transition: all 0.2s ease;
        border: 1px solid transparent;
    }
    .btn-pill:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    .brand-scroll-container {
        overflow-x: auto;
        padding-bottom: 5px;
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .brand-scroll-container::-webkit-scrollbar {
        display: none;
    }
    .size-grid {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.5rem;
    }
    .size-filter-input:checked + label {
        background-color: #212529 !important;
        color: white !important;
        border-color: #212529 !important;
    }
    /* --- FIX: UPDATED HOVER EFFECT --- */
    .product-card-img-container .product-card-img {
        transition: transform 0.3s ease;
    }
    .product-card-img-container:hover .product-card-img {
        /* Removed translate, using only scale to preserve position */
        transform: scale(1.05) !important;
    }
    /* -------------------------------- */
    .loading-opacity {
        opacity: 0.5;
        pointer-events: none;
        transition: opacity 0.2s ease;
    }
</style>

<script>
    let debounceTimer;

    function debounceFilter() {
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            applyFilters();
        }, 600); // Wait 600ms after typing stops
    }

    function clearPrice() {
        document.getElementById('minPrice').value = '';
        document.getElementById('maxPrice').value = '';
        applyFilters();
    }

    function applyFilters() {
        const form = document.getElementById('desktopFilterForm');
        const sortValue = document.getElementById('desktop-sort').value;
        const container = document.getElementById('product-grid-container');
        const countDisplay = document.getElementById('result-count');

        container.classList.add('loading-opacity');

        const formData = new FormData(form);
        const params = new URLSearchParams(formData);
        
        if(sortValue) params.append('sort', sortValue);

        const newUrl = `${window.location.pathname}?${params.toString()}`;
        window.history.pushState({path: newUrl}, '', newUrl);

        fetch(newUrl)
            .then(response => response.text())
            .then(html => {
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                
                const newGrid = doc.getElementById('product-grid-container');
                const newCount = doc.getElementById('result-count');
                
                if (newGrid) container.innerHTML = newGrid.innerHTML;
                if (newCount && countDisplay) countDisplay.innerHTML = newCount.innerHTML;
                
                container.classList.remove('loading-opacity');
            })
            .catch(err => {
                console.error('Error fetching filtered products:', err);
                container.classList.remove('loading-opacity');
            });
    }
</script>