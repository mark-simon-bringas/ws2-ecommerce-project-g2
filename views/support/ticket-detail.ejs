<div class="container mt-0 my-lg-5 pt-0 support-page-wrapper">
    <div class="row g-4 justify-content-center">
        <div class="col-lg-8 px-0 px-lg-3"> <div class="chat-container">
                <div class="chat-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <div style="min-width: 0;">
                            <h1 class="mb-0 text-truncate">Ticket #<%= ticket.ticketId %></h1>
                            <p class="text-body-secondary small mb-0 text-truncate"><%= ticket.subject %></p>
                        </div>
                        <div class="ms-2 flex-shrink-0">
                            <% if (ticket.status === 'Open') { %>
                                <span class="badge bg-primary-subtle text-primary-emphasis rounded-pill"><%= ticket.status %></span>
                            <% } else if (ticket.status === 'Answered') { %>
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill"><%= ticket.status %></span>
                            <% } else { %>
                                <span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill"><%= ticket.status %></span>
                            <% } %>
                        </div>
                    </div>
                </div>
                
                <div class="chat-messages" id="chat-messages">
                    <% ticket.messages.forEach(message => { %>
                        <% if (message.sender === 'user') { %>
                            <div class="chat-message user-message">
                                <div class="message-bubble">
                                    <%- message.message.replace(/\n/g, '<br>') %>
                                </div>
                                <div class="message-meta">
                                    <%= new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                                </div>
                            </div>
                        <% } else { %>
                            <div class="chat-message support-message">
                                <div class="message-bubble">
                                    <%- message.message.replace(/\n/g, '<br>') %>
                                </div>
                                <div class="message-meta">
                                    <%= message.adminName || 'Support' %> • <%= new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) %>
                                </div>
                            </div>
                        <% } %>
                    <% }) %>
                </div>

                <% if (ticket.status !== 'Closed') { %>
                    <div class="chat-reply-form">
                        <form id="reply-form">
                            <input type="hidden" name="userEmail" value="<%= ticket.userEmail %>">
                            
                            <div class="reply-box-wrapper">
                                <textarea 
                                    id="message-input" 
                                    name="message" 
                                    placeholder="Type a message..." 
                                    rows="1" 
                                    required
                                ></textarea>
                                <button type="submit" class="btn-send" aria-label="Send Message">
                                    <i class="bi bi-arrow-up-short"></i>
                                </button>
                            </div>
                        </form>
                    </div>
                <% } else { %>
                    <div class="chat-reply-form text-center bg-light">
                        <p class="text-body-secondary mb-0 small">This ticket is closed. <a href="/support/contact" class="text-decoration-underline">Open a new ticket</a>.</p>
                    </div>
                <% } %>
            </div>
        </div>
        
        <div class="col-lg-4 d-none d-lg-block">
             <div class="support-sidebar-card">
                <h5 class="fw-bold mb-3">Quick Links</h5>
                <ul class="list-unstyled d-flex flex-column gap-2">
                    <li>
                        <a href="/support/order-status" class="text-dark fw-medium d-flex align-items-center gap-2">
                            <i class="bi bi-box-seam"></i>
                            <span>Track Your Order</span>
                        </a>
                    </li>
                    <li>
                        <a href="/support/shipping" class="text-dark fw-medium d-flex align-items-center gap-2">
                            <i class="bi bi-truck"></i>
                            <span>Shipping Policy</span>
                        </a>
                    </li>
                    <li>
                        <a href="/support/returns" class="text-dark fw-medium d-flex align-items-center gap-2">
                            <i class="bi bi-arrow-counterclockwise"></i>
                            <span>Return Policy</span>
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>


<script src="/socket.io/socket.io.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const socket = io();
        const chatMessages = document.getElementById('chat-messages');
        const replyForm = document.getElementById('reply-form');
        const messageInput = document.getElementById('message-input');
        const ticketId = '<%= ticket.ticketId %>';
        const userName = '<%= ticket.messages[0].name %>';

        // Scroll to bottom immediately
        const scrollToBottom = () => {
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        };
        // Use requestAnimationFrame to ensure rendering is done before scrolling
        window.requestAnimationFrame(scrollToBottom);

        // 1. Join the specific ticket room
        socket.emit('joinTicket', ticketId);

        // 2. Listen for new messages
        socket.on('newMessage', (message) => {
            appendMessage(message);
        });

        // 3. Auto-resize Textarea Logic
        if (messageInput) {
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto'; // Reset height to recalculate
                this.style.height = (this.scrollHeight) + 'px';
                
                // Optional: Ensure we scroll to bottom if text grows
                scrollToBottom();
            });

            // 4. Handle Shift+Enter vs Enter
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault(); // Prevent default newline
                    if (this.value.trim() !== '') {
                        sendMessage(); // Submit
                    }
                }
            });
        }

        if (replyForm) {
            replyForm.addEventListener('submit', (e) => {
                e.preventDefault();
                sendMessage();
            });
        }

        function sendMessage() {
            const messageText = messageInput.value.trim();
            if (messageText) {
                const messageData = {
                    ticketId: ticketId,
                    message: messageText,
                    sender: 'user',
                    name: userName
                };
                
                // Emit to server
                socket.emit('chatMessage', messageData);
                
                // Reset Input
                messageInput.value = '';
                messageInput.style.height = 'auto'; // Reset size
                messageInput.focus();
            }
        }

        function appendMessage(message) {
            const messageElement = document.createElement('div');
            const isUserMessage = message.sender === 'user';
            
            messageElement.classList.add('chat-message', isUserMessage ? 'user-message' : 'support-message');
            
            const bubble = document.createElement('div');
            bubble.classList.add('message-bubble');
            bubble.innerHTML = message.message.replace(/\n/g, '<br>');

            const meta = document.createElement('div');
            meta.classList.add('message-meta');
            
            // Format time short (e.g., 10:30 AM)
            const timeString = new Date(message.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            const senderName = isUserMessage ? '' : (message.adminName || 'Support') + ' • ';
            
            meta.textContent = `${senderName}${timeString}`;

            messageElement.appendChild(bubble);
            messageElement.appendChild(meta);
            chatMessages.appendChild(messageElement);
            
            scrollToBottom();
        }
    });
</script>