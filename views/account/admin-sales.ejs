<div class="settings-page-wrapper" style="max-width: 1200px;">
    <div class="d-flex align-items-center mb-4">
        <a href="javascript:history.back()" class="btn btn-icon btn-light rounded-circle me-3">
                <i class="bi bi-arrow-left"></i>
        </a>
        <div>
            <h1 class="h3 fw-bold mb-0">Sales & Promotions</h1>
            <p class="text-body-secondary small mb-0">Manage campaigns and discounts</p>
        </div>
    </div>

    <% if (typeof message !== 'undefined' && message) { %>
        <div class="alert alert-success alert-dismissible fade show rounded-4 border-0 shadow-sm mb-4" role="alert">
            <i class="bi bi-check-circle-fill me-2"></i> <%= message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>
    
    <% if (typeof error !== 'undefined' && error) { %>
        <div class="alert alert-danger alert-dismissible fade show rounded-4 border-0 shadow-sm mb-4" role="alert">
            <i class="bi bi-exclamation-circle-fill me-2"></i> <%= error %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

    <div class="row g-4">
        <div class="col-lg-5">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">Create New Campaign</h5>
                    
                    <form action="/account/admin/sales/create" method="POST" id="create-sale-form">
                        <div class="mb-3">
                            <label for="saleName" class="form-label small fw-bold text-uppercase text-secondary">Campaign Name</label>
                            <input type="text" class="form-control bg-light border-0" id="saleName" name="saleName" placeholder="e.g., Summer Flash Sale" required>
                        </div>
                        
                        <div class="mb-3">
                            <label for="discountPercentage" class="form-label small fw-bold text-uppercase text-secondary">Discount</label>
                            <div class="input-group">
                                <input type="number" class="form-control bg-light border-0" id="discountPercentage" name="discountPercentage" min="1" max="100" placeholder="20" required>
                                <span class="input-group-text bg-light border-0 text-secondary">% OFF</span>
                            </div>
                        </div>

                        <div class="row g-3 mb-4">
                            <div class="col-6">
                                <label for="startDate" class="form-label small fw-bold text-uppercase text-secondary">Start Date</label>
                                <input type="date" class="form-control bg-light border-0" id="startDate" name="startDate" required>
                            </div>
                            <div class="col-6">
                                <label for="endDate" class="form-label small fw-bold text-uppercase text-secondary">End Date</label>
                                <input type="date" class="form-control bg-light border-0" id="endDate" name="endDate" required>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label class="form-label d-flex justify-content-between align-items-center mb-2">
                                <span class="small fw-bold text-uppercase text-secondary">Select Products</span>
                                <span class="badge bg-dark rounded-pill" id="selected-count-badge">0</span>
                            </label>
                            
                            <div class="input-group mb-2">
                                <span class="input-group-text bg-light border-0 ps-3"><i class="bi bi-search text-secondary"></i></span>
                                <input type="text" id="product-search" class="form-control bg-light border-0" placeholder="Search inventory...">
                            </div>

                            <div class="product-selection-list bg-light rounded-4 p-2" style="height: 300px; overflow-y: auto;">
                                <% products.forEach(product => { %>
                                    <div class="product-select-item p-2 rounded-3 d-flex align-items-center gap-3 mb-1 position-relative" data-name="<%= product.name.toLowerCase() %>" data-sku="<%= product.sku.toLowerCase() %>">
                                        <div class="form-check">
                                            <input type="checkbox" name="productIds" value="<%= product._id %>" class="form-check-input" id="chk-<%= product._id %>">
                                        </div>
                                        <img src="<%= product.thumbnailUrl %>" alt="" class="rounded-3 bg-white" style="width: 40px; height: 40px; object-fit: contain; padding: 2px;">
                                        <div class="flex-grow-1 min-w-0">
                                            <div class="fw-medium text-truncate" style="font-size: 0.9rem;"><%= product.name %></div>
                                            <div class="d-flex justify-content-between">
                                                <small class="text-secondary"><%= product.sku %></small>
                                                <small class="fw-bold">$<%= product.retailPrice %></small>
                                            </div>
                                        </div>
                                        <a href="#" class="stretched-link" onclick="toggleProductSelection(event, 'chk-<%= product._id %>', this)"></a>
                                    </div>
                                <% }) %>
                            </div>
                            <div class="d-flex justify-content-end mt-2 gap-3">
                                <button type="button" class="btn btn-link btn-sm text-decoration-none p-0" onclick="selectAll(true)">Select All</button>
                                <button type="button" class="btn btn-link btn-sm text-decoration-none p-0 text-secondary" onclick="selectAll(false)">Clear</button>
                            </div>
                        </div>

                        <div class="d-grid">
                            <button type="submit" class="btn btn-dark rounded-pill py-3">Launch Campaign</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="card border-0 shadow-sm rounded-4 h-100">
                <div class="card-body p-4">
                    <h5 class="fw-bold mb-4">Active Campaigns</h5>
                    
                    <% if (sales && sales.length > 0) { %>
                        <div class="d-flex flex-column gap-3">
                            <% sales.forEach(sale => { %>
                                <% 
                                    const now = new Date();
                                    const startDate = new Date(sale.startDate);
                                    const endDate = new Date(sale.endDate);
                                    endDate.setHours(23, 59, 59, 999);
                                    let statusBadge = '<span class="badge bg-secondary-subtle text-secondary-emphasis rounded-pill">Expired</span>';
                                    let opacityClass = 'opacity-75';

                                    if (now >= startDate && now <= endDate) {
                                        statusBadge = '<span class="badge bg-success-subtle text-success-emphasis rounded-pill">Active Now</span>';
                                        opacityClass = '';
                                    } else if (now < startDate) {
                                        statusBadge = '<span class="badge bg-info-subtle text-info-emphasis rounded-pill">Scheduled</span>';
                                        opacityClass = '';
                                    }
                                %>
                                <div class="card border-0 bg-light rounded-4 <%= opacityClass %>">
                                    <div class="card-body p-3">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <h6 class="fw-bold mb-1"><%= sale.name %></h6>
                                                <div class="text-secondary small">
                                                    <%= new Date(sale.startDate).toLocaleDateString() %> â€” <%= new Date(sale.endDate).toLocaleDateString() %>
                                                </div>
                                            </div>
                                            <%- statusBadge %>
                                        </div>
                                        <div class="d-flex align-items-center gap-3 mt-3">
                                            <div class="d-flex align-items-center gap-2 bg-white px-3 py-1 rounded-pill border">
                                                <i class="bi bi-tag-fill text-danger"></i>
                                                <span class="fw-bold"><%= sale.discountPercentage %>% OFF</span>
                                            </div>
                                            <div class="d-flex align-items-center gap-2 text-secondary small">
                                                <i class="bi bi-box-seam"></i>
                                                <span><%= sale.productIds.length %> Items</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    <% } else { %>
                        <div class="text-center py-5">
                            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                <i class="bi bi-calendar-x text-secondary fs-4"></i>
                            </div>
                            <p class="text-secondary">No active sales found.</p>
                        </div>
                    <% } %>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .settings-page-wrapper {
        margin: 0 auto;
        padding: 1rem;
    }
    .btn-icon {
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 1px solid var(--border-color);
    }
    .product-select-item {
        transition: background-color 0.2s;
        cursor: pointer;
    }
    .product-select-item:hover {
        background-color: #fff;
    }
    .product-select-item.selected {
        background-color: #fff;
        border: 1px solid var(--nike-black);
    }
    /* Hide default checkbox visually but keep accessible if needed, 
       or just style the row. Here we keep it simple. */
</style>

<script>
    // --- Search Functionality ---
    document.getElementById('product-search').addEventListener('input', function(e) {
        const term = e.target.value.toLowerCase();
        const items = document.querySelectorAll('.product-select-item');
        
        items.forEach(item => {
            const name = item.dataset.name;
            const sku = item.dataset.sku;
            if (name.includes(term) || sku.includes(term)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    });

    // --- Selection Logic ---
    function toggleProductSelection(e, checkboxId, link) {
        e.preventDefault(); 
        const checkbox = document.getElementById(checkboxId);
        const row = link.closest('.product-select-item');
        
        checkbox.checked = !checkbox.checked;
        updateRowStyle(row, checkbox.checked);
        updateCount();
    }

    function updateRowStyle(row, isChecked) {
        if (isChecked) {
            row.classList.add('selected', 'shadow-sm');
        } else {
            row.classList.remove('selected', 'shadow-sm');
        }
    }

    function updateCount() {
        const count = document.querySelectorAll('input[name="productIds"]:checked').length;
        document.getElementById('selected-count-badge').textContent = count;
    }

    function selectAll(select) {
        const items = document.querySelectorAll('.product-select-item');
        items.forEach(item => {
            if (item.style.display !== 'none') { 
                const checkbox = item.querySelector('input[type="checkbox"]');
                checkbox.checked = select;
                updateRowStyle(item, select);
            }
        });
        updateCount();
    }
</script>