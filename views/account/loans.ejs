<div class="settings-page-wrapper" style="max-width: 900px;">
    <div class="d-flex align-items-center mb-5">
        <a href="/account/settings" class="btn btn-icon btn-light rounded-circle me-3 shadow-sm border-0 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
            <i class="bi bi-arrow-left fs-5"></i>
        </a>
        <div>
            <h1 class="h3 fw-bold mb-0">My Financing</h1>
            <p class="text-secondary small mb-0">Manage your installment plans</p>
        </div>
    </div>

    <% if (loans && loans.length > 0) { %>
        <div class="row g-4">
            <% loans.forEach(loan => { %>
                <div class="col-12">
                    <div class="card border-0 shadow-sm rounded-4 overflow-hidden loan-card">
                        <div class="card-body p-4">
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-4 gap-3">
                                <div class="d-flex align-items-center gap-3">
                                    <div class="icon-box bg-dark text-white rounded-3 d-flex align-items-center justify-content-center" style="width: 48px; height: 48px;">
                                        <i class="bi bi-credit-card-2-front fs-4"></i>
                                    </div>
                                    <div>
                                        <h5 class="fw-bold mb-0"><%= loan.plan %></h5>
                                        <small class="text-secondary">Order #<%= loan.orderId.toString().slice(-6).toUpperCase() %></small>
                                    </div>
                                </div>
                                <div class="text-md-end">
                                    <% if (loan.status === 'Active') { %>
                                        <span class="badge bg-success-subtle text-success border border-success-subtle rounded-pill px-3 py-2">Active</span>
                                    <% } else { %>
                                        <span class="badge bg-secondary-subtle text-secondary border border-secondary-subtle rounded-pill px-3 py-2">Paid Off</span>
                                    <% } %>
                                </div>
                            </div>

                            <div class="mb-4">
                                <div class="d-flex justify-content-between align-items-end mb-2">
                                    <div>
                                        <p class="text-secondary small mb-0 text-uppercase fw-bold">Balance Remaining</p>
                                        <h3 class="fw-bold mb-0"><%= locationData.symbol %><%= loan.remaining.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></h3>
                                    </div>
                                    <div class="text-end">
                                        <span class="small fw-bold"><%= loan.paymentsMade %> / <%= loan.totalPayments %> Payments</span>
                                    </div>
                                </div>
                                <div class="progress" style="height: 8px; background-color: #f0f0f0; border-radius: 10px;">
                                    <div class="progress-bar bg-dark" role="progressbar" style="width: <%= loan.progress %>%; border-radius: 10px;"></div>
                                </div>
                            </div>

                            <div class="bg-light rounded-3 p-3 mb-4">
                                <div class="row g-3 text-center text-md-start">
                                    <div class="col-6 col-md-4">
                                        <small class="text-secondary d-block mb-1">Total Amount</small>
                                        <span class="fw-bold"><%= locationData.symbol %><%= loan.total.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                                    </div>
                                    <div class="col-6 col-md-4">
                                        <small class="text-secondary d-block mb-1">Next Payment</small>
                                        <% if (loan.nextPayment) { %>
                                            <span class="fw-bold text-dark"><%= new Date(loan.nextPayment).toLocaleDateString() %></span>
                                        <% } else { %>
                                            <span class="fw-bold text-success">Completed</span>
                                        <% } %>
                                    </div>
                                    <div class="col-12 col-md-4 text-md-end">
                                        <small class="text-secondary d-block mb-1">Auto-Pay</small>
                                        <span class="fw-medium text-dark"><i class="bi bi-check-circle-fill text-success me-1"></i> Enabled</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-flex align-items-center gap-2">
                                <% loan.items.forEach(item => { %>
                                    <img src="<%= item.thumbnailUrl %>" class="rounded-2 border bg-white" style="width: 40px; height: 40px; object-fit: contain;" title="<%= item.name %>">
                                <% }) %>
                                <a href="/account/orders/<%= loan.orderId %>" class="btn btn-link text-dark fw-bold small text-decoration-none ms-auto">View Order details <i class="bi bi-arrow-right"></i></a>
                            </div>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
    <% } else { %>
        <div class="text-center py-5">
            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                <i class="bi bi-wallet2 text-secondary fs-1"></i>
            </div>
            <h4 class="fw-bold">No active plans</h4>
            <p class="text-secondary mb-4">You don't have any active financing plans at the moment.</p>
            <a href="/products" class="btn btn-dark rounded-pill px-4 py-2 fw-bold">Shop Now</a>
        </div>
    <% } %>
</div>

<style>
    .settings-page-wrapper { margin: 0 auto; padding: 1rem; }
    .btn-icon { border: 1px solid var(--border-color); transition: all 0.2s; }
    .btn-icon:hover { transform: scale(1.05); background-color: #fff; }
    .loan-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .loan-card:hover { transform: translateY(-2px); box-shadow: 0 8px 24px rgba(0,0,0,0.06) !important; }
</style>