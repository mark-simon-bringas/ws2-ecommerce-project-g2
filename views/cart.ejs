<div class="container my-5 cart-page-container" style="max-width: 1200px;">
    <div class="row gx-lg-5">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-end mb-4">
                <div>
                    <h1 class="h2 fw-bold mb-1">Shopping Bag</h1>
                    <p class="text-body-secondary small mb-0">
                        <% if (cart && cart.totalQty > 0) { %>
                            <%= cart.totalQty %> items in your bag.
                        <% } else { %>
                            Your bag is empty.
                        <% } %>
                    </p>
                </div>
                <a href="/products" class="text-decoration-underline text-dark fw-medium small d-none d-md-block">Continue Shopping</a>
            </div>

            <% if (cart && cart.items.length > 0) { %>
                <div class="d-flex flex-column gap-3 mb-5 cart-items-scroll-container">
                    <% cart.items.forEach(item => { %>
                        <div class="card border-0 shadow-sm rounded-4 overflow-hidden cart-item-card flex-shrink-0">
                            <div class="card-body p-3 p-md-4 d-flex gap-3 gap-md-4 align-items-center">
                                <a href="/products/<%= item.sku %>" class="flex-shrink-0">
                                    <img src="<%= item.thumbnailUrl %>" alt="<%= item.name %>" class="rounded-3 bg-body-secondary object-fit-contain border" style="width: 80px; height: 80px;">
                                </a>

                                <div class="flex-grow-1 min-w-0">
                                    <div class="d-flex justify-content-between align-items-start mb-1">
                                        <h6 class="fw-normal mb-0 text-truncate pe-2" style="max-width: 180px;">
                                            <a href="/products/<%= item.sku %>" class="text-dark text-decoration-none"><%= item.name %></a>
                                        </h6>
                                        <span class="fw-bold text-dark flex-shrink-0" style="font-size: 0.9rem;"><%= locationData.symbol %><%= item.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                                    </div>
                                    <p class="text-secondary small mb-2" style="font-size: 0.8rem;"><%= item.brand %> â€¢ Size: <%= item.size %></p>
                                    
                                    <div class="d-flex justify-content-between align-items-end mt-2">
                                        <div class="quantity-selector-pill d-inline-flex align-items-center border rounded-pill p-1" style="height: 32px;">
                                            <% if (item.qty > 1) { %>
                                                <form action="/cart/update-quantity" method="POST" class="d-inline">
                                                    <input type="hidden" name="itemId" value="<%= item.itemId %>">
                                                    <input type="hidden" name="change" value="-1">
                                                    <button type="submit" class="btn btn-icon-xs btn-light rounded-circle border-0 text-secondary" style="width: 24px; height: 24px;">
                                                        <i class="bi bi-dash"></i>
                                                    </button>
                                                </form>
                                            <% } else { %>
                                                <form action="/cart/remove" method="POST" class="d-inline">
                                                    <input type="hidden" name="itemId" value="<%= item.itemId %>">
                                                    <button type="submit" class="btn btn-icon-xs btn-light rounded-circle border-0 text-danger" style="width: 24px; height: 24px;">
                                                        <i class="bi bi-trash"></i>
                                                    </button>
                                                </form>
                                            <% } %>
                                            
                                            <span class="mx-2 small fw-bold" style="min-width: 1.5ch; text-align: center; font-size: 0.85rem;"><%= item.qty %></span>
                                            
                                            <form action="/cart/update-quantity" method="POST" class="d-inline">
                                                <input type="hidden" name="itemId" value="<%= item.itemId %>">
                                                <input type="hidden" name="change" value="1">
                                                <button type="submit" class="btn btn-icon-xs btn-light rounded-circle border-0 text-secondary" style="width: 24px; height: 24px;">
                                                    <i class="bi bi-plus"></i>
                                                </button>
                                            </form>
                                        </div>

                                        <div class="d-flex gap-3">
                                            <% if (currentUser) { %>
                                                <form action="/cart/add-to-wishlist-from-cart" method="POST" class="wishlist-form-cart">
                                                    <input type="hidden" name="itemId" value="<%= item.itemId %>">
                                                    <input type="hidden" name="productId" value="<%= item.productId %>">
                                                    <% const isItemWishlisted = wishlist.some(id => id.equals(item.productId)); %>
                                                    <button type="submit" class="btn btn-link text-decoration-none p-0 text-secondary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                        <i class="bi <%= isItemWishlisted ? 'bi-heart-fill text-danger' : 'bi-heart' %> fs-5"></i> 
                                                    </button>
                                                </form>
                                            <% } %>
                                            <form action="/cart/remove" method="POST" class="d-inline">
                                                <input type="hidden" name="itemId" value="<%= item.itemId %>">
                                                <button type="submit" class="btn btn-link text-decoration-none p-0 text-secondary d-flex align-items-center justify-content-center" style="width: 32px; height: 32px;">
                                                    <i class="bi bi-trash fs-5"></i>
                                                </button>
                                            </form>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="card border-0 shadow-sm rounded-4 mb-5">
                    <div class="card-body p-5 text-center">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                            <i class="bi bi-bag text-secondary fs-1"></i>
                        </div>
                        <h3 class="fw-bold mb-2">Your bag is empty</h3>
                        <p class="text-secondary mb-4">Looks like you haven't added anything yet.</p>
                        <a href="/products" class="btn btn-dark rounded-pill px-5 py-3 fw-bold">Start Shopping</a>
                    </div>
                </div>
            <% } %>
            
            <div class="d-none d-lg-block mt-5 pt-4 border-top">
                 <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="fw-bold mb-0">Favorites</h4>
                    <a href="/account/wishlist" class="text-decoration-none small fw-bold text-dark">View All</a>
                 </div>
                 <% if (currentUser && wishlistProducts && wishlistProducts.length > 0) { %>
                    <div class="product-carousel-wrapper">
                        <div class="product-carousel">
                            <% wishlistProducts.forEach(product => { %>
                                <div class="product-card" style="min-width: 200px;">
                                    <div class="product-card-img-container rounded-4 bg-light mb-2 position-relative">
                                        <a href="/products/<%= product.sku %>" class="stretched-link"></a>
                                        <img src="<%= product.thumbnailUrl %>" class="w-100 object-fit-contain p-3" style="height: 160px;" alt="<%= product.name %>">
                                    </div>
                                    <div class="product-card-body">
                                        <h6 class="fw-bold text-truncate mb-0"><%= product.name %></h6>
                                        <small class="text-secondary"><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></small>
                                    </div>
                                </div>
                            <% }) %>
                        </div>
                    </div>
                 <% } else { %>
                    <p class="text-secondary small">Items you save will appear here.</p>
                 <% } %>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card border-0 shadow-sm rounded-4 summary-card-sticky" style="position: sticky; top: 100px;">
                <div class="card-body p-4">
                    <h4 class="fw-bold mb-4">Summary</h4>
                    
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-secondary">Subtotal</span>
                        <span class="fw-medium"><%= locationData.symbol %><%= (cart.convertedTotalPrice || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                    </div>
                    
                    <% if (cart && cart.items.length > 0) { %>
                        <div class="d-flex justify-content-between mb-3">
                            <span class="text-secondary">Estimated Shipping</span>
                            <span class="fw-medium"><%= shippingCost > 0 ? locationData.symbol + shippingCost.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : 'Free' %></span>
                        </div>
                    <% } %>

                    <hr class="my-4 border-secondary-subtle">

                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <span class="fw-bold fs-5">Total</span>
                        <span class="fw-bold fs-5"><%= locationData.symbol %><%= (cart && cart.items.length > 0 ? totalWithShipping : 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                    </div>

                    <div class="d-grid gap-3">
                        <% if (currentUser) { %>
                            <a href="/checkout" class="btn btn-dark btn-lg rounded-pill py-3 fw-bold <%= (cart && cart.items.length > 0) ? '' : 'disabled' %>">
                                Checkout
                            </a>
                        <% } else { %>
                            <a href="/checkout" class="btn btn-dark btn-lg rounded-pill py-3 fw-bold <%= (cart && cart.items.length > 0) ? '' : 'disabled' %>">
                                Guest Checkout
                            </a>
                            <a href="/users/login?redirect=/checkout" class="btn btn-outline-dark btn-lg rounded-pill py-3 fw-bold <%= (cart && cart.items.length > 0) ? '' : 'disabled' %>">
                                Member Checkout
                            </a>
                        <% } %>
                    </div>
                    
                    <div class="mt-4 text-center">
                         <p class="small text-secondary mb-0"><i class="bi bi-shield-lock-fill me-1"></i> Secure Checkout</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    /* Custom styles specifically for the Cart Page */
    .btn-icon-xs {
        width: 24px;
        height: 24px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1rem;
    }
    .cart-item-card:hover {
        transform: translateY(-2px);
        transition: transform 0.2s ease;
    }

    /* Mobile Scrollable List */
    @media (max-width: 991.98px) {
        .cart-items-scroll-container {
            /* 50vh ensures it takes up half the screen, prompting scroll if items exceed that */
            max-height: 50vh; 
            min-height: 300px; 
            overflow-y: auto;
            padding-right: 2px;
            
            /* Removed contain to allow bubbling up to body scroll */
            /* overscroll-behavior: contain; */
            
            -webkit-overflow-scrolling: touch;
            
            background-color: #fff;
            border-top: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
        
        /* Hide scrollbar visual but keep functionality */
        .cart-items-scroll-container::-webkit-scrollbar {
            display: none;
        }
        
        /* Adjust image size for mobile */
        .cart-item-card img {
            width: 80px !important;
            height: 80px !important;
        }
    }
</style>