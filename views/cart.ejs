<div class="container my-5 cart-page-container">
    <div class="row gx-lg-5">
        <div class="col-lg-8">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h2 mb-0">Bag</h1>
                <% if (cart && cart.items.length > 0) { %>
                    <span class="text-body-secondary"><%= cart.totalQty %> items | <%= locationData.symbol %><%= cart.convertedTotalPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                <% } %>
            </div>

            <% if (cart && cart.items.length > 0) { %>
                <div class="cart-items-container">
                    <% cart.items.forEach(item => { %>
                        <div class="cart-item">
                            <img src="<%= item.thumbnailUrl %>" alt="<%= item.name %>" class="cart-item-image">
                            <div class="cart-item-details">
                                <div>
                                    <div class="d-flex justify-content-between">
                                        <h6 class="mb-0"><%= item.name %></h6>
                                        <span class="cart-item-price fw-semibold"><%= locationData.symbol %><%= item.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                                    </div>
                                    <p class="text-body-secondary small mb-1"><%= item.brand %></p>
                                    <p class="text-body-secondary small">Size: <%= item.size %></p>
                                </div>
                                <div class="cart-item-actions">
                                    <div class="quantity-selector">
                                        <% if (item.qty > 1) { %>
                                            <form action="/cart/update-quantity" method="POST" class="d-inline">
                                                <input type="hidden" name="itemId" value="<%= item.itemId %>">
                                                <input type="hidden" name="change" value="-1">
                                                <button type="submit" class="btn btn-sm btn-light rounded-circle">-</button>
                                            </form>
                                        <% } else { %>
                                            <form action="/cart/remove" method="POST" class="d-inline">
                                                <input type="hidden" name="itemId" value="<%= item.itemId %>">
                                                <button type="submit" class="btn btn-sm btn-light rounded-circle" title="Remove item"><i class="bi bi-trash3"></i></button>
                                            </form>
                                        <% } %>
                                        <span class="mx-2"><%= item.qty %></span>
                                        <form action="/cart/update-quantity" method="POST" class="d-inline">
                                            <input type="hidden" name="itemId" value="<%= item.itemId %>">
                                            <input type="hidden" name="change" value="1">
                                            <button type="submit" class="btn btn-sm btn-light rounded-circle">+</button>
                                        </form>
                                    </div>
                                    <% if (currentUser) { %>
                                        <form action="/cart/move-to-wishlist" method="POST">
                                            <input type="hidden" name="itemId" value="<%= item.itemId %>">
                                            <input type="hidden" name="productId" value="<%= item.productId %>">
                                            <button type="submit" class="btn btn-sm btn-light rounded-circle ms-2" title="Move to Wishlist"><i class="bi bi-heart"></i></button>
                                        </form>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                    <% }) %>
                </div>
            <% } else { %>
                <div class="text-center p-5 bg-light rounded-4">
                    <h3 class="text-body-secondary">Your bag is empty.</h3>
                    <p class="lead text-body-secondary">Looks like you haven't added anything yet.</p>
                    <a href="/" class="btn btn-dark mt-3">Continue Shopping</a>
                </div>
            <% } %>
        </div>

        <div class="col-lg-4">
            <div class="summary-card-desktop">
                <h4 class="mb-3">Summary</h4>
                <div class="summary-item">
                    <span>Subtotal</span>
                    <span><%= locationData.symbol %><%= (cart.convertedTotalPrice || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                </div>
                <div class="summary-item">
                    <span>Estimated Delivery & Handling</span>
                    <span>Free</span>
                </div>
                <hr>
                <div class="summary-total">
                    <span>Total</span>
                    <span><%= locationData.symbol %><%= (cart.convertedTotalPrice || 0).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                </div>
                <hr>
                <div class="d-none d-lg-grid gap-3" id="desktop-checkout-buttons">
                    <a href="/checkout" class="btn btn-primary btn-lg <%= (cart && cart.items.length > 0) ? '' : 'disabled' %>">
                        Guest Checkout
                    </a>
                    <a href="<%= currentUser ? '/checkout' : '/users/login' %>" class="btn btn-outline-secondary btn-lg <%= (cart && cart.items.length > 0) ? '' : 'disabled' %>">
                        Member Checkout
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<section class="product-carousel-section container-fluid mt-5 py-5 border-top">
    <div class="container">
        <div class="section-header">
            <h2 class="h3 fw-bold mb-0">Favourites</h2>
        </div>
        <% if (currentUser && wishlistProducts && wishlistProducts.length > 0) { %>
            <div class="product-carousel">
                <% wishlistProducts.forEach(product => { %>
                    <div class="product-card" data-sku="<%= product.sku %>">
                        <div class="product-card-img-container">
                            <a href="/products/<%= product.sku %>" class="product-card-img-link"></a>
                            <img src="<%= product.thumbnailUrl %>" class="product-card-img" alt="<%= product.name %>">
                        </div>
                        <div class="product-card-body">
                            <a href="/products/<%= product.sku %>" class="text-decoration-none">
                                <div class="product-title"><%= product.name %></div>
                                <div class="product-price"><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></div>
                            </a>
                        </div>
                    </div>
                <% }) %>
            </div>
        <% } else { %>
            <p class="text-body-secondary">Want to view your favourites? <a href="/users/login" class="text-dark fw-semibold">Sign in</a> or <a href="/users/register" class="text-dark fw-semibold">Join us</a>.</p>
        <% } %>
    </div>
</section>

<div class="mobile-checkout-sticky d-lg-none">
    <div class="checkout-options" id="checkout-options">
        <div class="d-grid gap-3 p-3">
            <a href="/checkout" class="btn btn-primary btn-lg <%= (cart && cart.items.length > 0) ? '' : 'disabled' %>">
                Guest Checkout
            </a>
            <a href="<%= currentUser ? '/checkout' : '/users/login' %>" class="btn btn-outline-secondary btn-lg <%= (cart && cart.items.length > 0) ? '' : 'disabled' %>">
                Member Checkout
            </a>
        </div>
    </div>
    <button id="mobile-checkout-btn" class="btn btn-dark btn-lg w-100 <%= (cart && cart.items.length > 0) ? '' : 'disabled' %>">
        Go to Checkout
    </button>
</div>