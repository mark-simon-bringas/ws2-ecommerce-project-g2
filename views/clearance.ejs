<div class="container my-5 py-5">
    <div class="text-center mb-5 bg-dark text-white rounded-4 p-5 position-relative overflow-hidden">
        <div class="position-relative z-1">
            <span class="badge bg-danger text-uppercase tracking-wide mb-3 px-3 py-2">Limited Time Offers</span>
            <h1 class="display-4 fw-bold mb-3">Clearance Sale</h1>
            <p class="lead text-white-50 mb-0">Up to 50% off on selected styles. Grab them before they're gone.</p>
        </div>
        <div class="position-absolute top-0 start-0 w-100 h-100 opacity-20" style="background: url('https://images.unsplash.com/photo-1556906781-9a412961c28c?q=80&w=2070&auto=format&fit=crop') center/cover;"></div>
    </div>

    <div class="d-flex justify-content-center gap-2 mb-5">
        <a href="/products/clearance" class="btn rounded-pill px-4 fw-bold <%= currentCategory === 'all' ? 'btn-dark' : 'btn-outline-dark' %>">All</a>
        <a href="/products/clearance?category=men" class="btn rounded-pill px-4 fw-bold <%= currentCategory === 'men' ? 'btn-dark' : 'btn-outline-dark' %>">Men</a>
        <a href="/products/clearance?category=women" class="btn rounded-pill px-4 fw-bold <%= currentCategory === 'women' ? 'btn-dark' : 'btn-outline-dark' %>">Women</a>
    </div>

    <% if (products && products.length > 0) { %>
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3 g-md-4">
            <% products.forEach(product => { %>
                <div class="col">
                    <div class="product-card h-100" data-sku="<%= product.sku %>">
                        <div class="product-card-img-container">
                            <a href="/products/<%= product.sku %>" class="product-card-img-link"></a>
                            <img src="<%= product.thumbnailUrl %>" class="product-card-img" alt="<%= product.name %>" loading="lazy">
                            
                            <div class="position-absolute top-0 start-0 p-2 z-2">
                                <span class="badge bg-danger rounded-pill shadow-sm discount-badge">
                                    -<%= product.discountPercentage %>%
                                </span>
                            </div>

                            <div class="product-card-actions">
                                <% if (currentUser) { %>
                                    <button type="button" class="btn-action wishlist-toggle-btn" title="Toggle Wishlist" data-product-id="<%= product._id %>">
                                        <% const isWishlisted = wishlist.some(id => id.equals(product._id)); %>
                                        <i class="bi <%= isWishlisted ? 'bi-heart-fill' : 'bi-heart' %>"></i>
                                    </button>
                                <% } else { %>
                                    <a href="/users/login?redirect=/products/clearance" class="btn-action">
                                        <i class="bi bi-heart"></i>
                                    </a>
                                <% } %>
                                <button type="button" class="btn-action" title="Add to Cart" data-bs-toggle="modal" data-bs-target="#productModal-<%= product.sku %>">
                                    <i class="bi bi-bag-plus"></i>
                                </button>
                            </div>
                        </div>
                        <div class="product-card-body d-flex flex-column h-100">
                            <a href="/products/<%= product.sku %>" class="text-decoration-none flex-grow-1">
                                <div class="product-title text-truncate"><%= product.name %></div>
                                <div class="product-price mt-auto">
                                    <span class="fw-bold text-danger fs-5 me-1 sale-price-text">
                                        <%= locationData.symbol %><%= product.convertedSalePrice.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
                                    </span>
                                    <del class="text-body-secondary small original-price-text">
                                        <%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 0 }) %>
                                    </del>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            <% }) %>
        </div>
    <% } else { %>
        <div class="text-center py-5">
            <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 80px; height: 80px;">
                <i class="bi bi-tag text-secondary fs-1 opacity-50"></i>
            </div>
            <h3 class="fw-bold">No clearance items found</h3>
            <p class="text-secondary">We couldn't find any <%= currentCategory !== 'all' ? currentCategory : '' %> items on sale right now.</p>
            <a href="/products" class="btn btn-dark rounded-pill mt-3 px-4">Shop New Arrivals</a>
        </div>
    <% } %>
</div>

<% if (products && products.length > 0) { %>
    <% products.forEach(product => { %>
        <div class="modal fade quick-add-modal" id="productModal-<%= product.sku %>" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header border-0 pb-0">
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body text-center pt-0">
                        <img src="<%= product.thumbnailUrl %>" alt="<%= product.name %>" class="img-fluid rounded-3 mb-3" style="max-height: 200px;">
                        <h5 class="fw-bold mb-1"><%= product.name %></h5>
                        <p class="text-danger fw-bold mb-3">
                            <%= locationData.symbol %><%= product.convertedSalePrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %>
                            <span class="text-decoration-line-through text-muted small ms-2"><%= locationData.symbol %><%= product.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                        </p>
                        
                        <form action="/cart/add" method="POST">
                            <input type="hidden" name="productId" value="<%= product._id %>">
                            <input type="hidden" name="sku" value="<%= product.sku %>">
                            <div class="mb-3 text-start">
                                <label class="form-label small fw-bold text-uppercase text-secondary">Select Size</label>
                                <div class="d-flex flex-wrap gap-2">
                                    <% ['8', '8.5', '9', '9.5', '10', '10.5', '11', '12'].forEach(size => { %>
                                        <% 
                                            const safeSizeKey = size.replace('.', '_');
                                            const isSizeAvailable = product.stock && product.stock[safeSizeKey] > 0;
                                        %>
                                        <input type="radio" class="btn-check" name="size" id="modal-size-<%= product.sku %>-<%= size %>" value="<%= size %>" required <%= !isSizeAvailable ? 'disabled' : '' %>>
                                        <label class="btn btn-outline-dark rounded-3 py-1 px-2 small <%= !isSizeAvailable ? 'opacity-50 text-decoration-line-through' : '' %>" for="modal-size-<%= product.sku %>-<%= size %>"><%= size %></label>
                                    <% }) %>
                                </div>
                            </div>
                            <button type="submit" class="btn btn-dark w-100 rounded-pill py-3 fw-bold">Add to Cart</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    <% }) %>
<% } %>

<style>
    .tracking-wide { letter-spacing: 0.1em; }
    .opacity-20 { opacity: 0.2; }

    /* Mobile optimizations for 2-column grid */
    @media (max-width: 768px) {
        .product-card-img {
            height: 160px; /* Reduced height for mobile */
            padding: 0.5rem;
        }
        .product-title {
            font-size: 0.85rem;
        }
        .sale-price-text {
            font-size: 1rem !important;
        }
        .original-price-text {
            font-size: 0.75rem;
        }
        .discount-badge {
            font-size: 0.65rem;
            padding: 0.35em 0.5em;
        }
        /* Hide action buttons on mobile cards to keep it clean - users click card to view details */
        .product-card-actions {
            display: none; 
        }
    }
</style>