<div class="container my-5 checkout-page-wrapper" style="max-width: 1200px;">
    <div class="row gx-lg-5">
        
        <div class="col-12 d-lg-none mb-4">
            <div class="card border-0 shadow-sm rounded-4 overflow-hidden">
                <div class="accordion" id="orderSummaryAccordion">
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header" id="headingOne">
                            <button class="accordion-button collapsed bg-white shadow-none py-3" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOne" aria-expanded="false" aria-controls="collapseOne">
                                <div class="d-flex justify-content-between w-100 pe-3 align-items-center">
                                    <span class="fw-semibold text-dark d-flex align-items-center gap-2">
                                        <i class="bi bi-bag-check"></i> Show Order Summary
                                    </span>
                                    <strong class="fw-bold text-dark"><%= locationData.symbol %><%= totalWithShipping.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></strong>
                                </div>
                            </button>
                        </h2>
                        <div id="collapseOne" class="accordion-collapse collapse" aria-labelledby="headingOne" data-bs-parent="#orderSummaryAccordion">
                            <div class="accordion-body bg-light pt-0">
                                <div class="pt-3">
                                    <div class="mb-3">
                                        <label class="form-label small fw-bold text-secondary text-uppercase">Discount Code</label>
                                        <div class="input-group mb-2">
                                            <input type="text" id="voucher-code-mobile" class="form-control bg-white border-0" placeholder="Code">
                                            <button class="btn btn-dark" type="button" onclick="applyVoucher('mobile')">Apply</button>
                                        </div>
                                        <button type="button" class="btn btn-outline-secondary w-100 py-3 d-flex justify-content-between align-items-center bg-white" data-bs-toggle="modal" data-bs-target="#voucherWalletModal">
                                            <span class="fw-medium"><i class="bi bi-ticket-perforated me-2"></i> Select from Wallet</span>
                                            <% if (availableVouchers && availableVouchers.length > 0) { %>
                                                <span class="badge bg-dark rounded-pill"><%= availableVouchers.length %></span>
                                            <% } %>
                                        </button>
                                        <div id="voucher-message-mobile" class="mt-2 small"></div>
                                        <% if (typeof appliedVoucher !== 'undefined' && appliedVoucher) { %>
                                            <div class="alert alert-success mt-2 py-2 small d-flex justify-content-between align-items-center rounded-3 border-0 bg-success-subtle text-success-emphasis mb-0">
                                                <span><i class="bi bi-check-circle-fill me-1"></i> Applied: <strong><%= appliedVoucher.code %></strong></span>
                                                <span class="fw-bold">-<%= locationData.symbol %><%= discountAmount.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                                            </div>
                                            <div class="text-end mt-1">
                                                <button onclick="removeVoucher()" class="btn btn-link text-danger p-0 small text-decoration-none">Remove Voucher</button>
                                            </div>
                                        <% } %>
                                    </div>

                                    <% if (shipping.amountNeeded > 0) { %>
                                        <div class="mb-3 p-3 bg-white rounded-3 border">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <small class="text-body-secondary">Add <strong><%= locationData.symbol %><%= shipping.amountNeeded.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></strong> for free shipping</small>
                                                <small class="fw-bold"><%= parseInt(shipping.progress) %>%</small>
                                            </div>
                                            <div class="progress" style="height: 6px;">
                                                <div class="progress-bar bg-dark" role="progressbar" style="width: <%= shipping.progress %>%;"></div>
                                            </div>
                                        </div>
                                    <% } else { %>
                                        <div class="mb-3 p-2 bg-success-subtle text-success rounded-3 text-center small fw-bold">
                                            <i class="bi bi-check-circle-fill me-1"></i> You have qualified for Free Shipping!
                                        </div>
                                    <% } %>

                                    <% cart.items.forEach(item => { %>
                                        <div class="d-flex gap-3 mb-3 align-items-center">
                                            <div class="position-relative me-2">
                                                <img src="<%= item.thumbnailUrl %>" alt="<%= item.name %>" class="rounded-3 border bg-white" style="width: 64px; height: 64px; object-fit: contain;">
                                                <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary border border-light" style="font-size: 0.7rem; z-index: 2;"><%= item.qty %></span>
                                            </div>
                                            <div class="flex-grow-1">
                                                <h6 class="fw-medium mb-0 text-dark small"><%= item.name %></h6>
                                                <small class="text-secondary"><%= item.brand %></small>
                                            </div>
                                            <span class="fw-semibold small"><%= locationData.symbol %><%= item.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                                        </div>
                                    <% }) %>
                                    
                                    <hr class="border-secondary-subtle">
                                    
                                    <div class="d-flex justify-content-between mb-2 small">
                                        <span class="text-secondary">Subtotal</span>
                                        <span class="fw-medium"><%= locationData.symbol %><%= cart.convertedTotalPrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                                    </div>
                                    <% if (typeof discountAmount !== 'undefined' && discountAmount > 0) { %>
                                        <div class="d-flex justify-content-between mb-2 small text-success">
                                            <span>Discount</span>
                                            <span class="fw-medium">-<%= locationData.symbol %><%= discountAmount.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                                        </div>
                                    <% } %>
                                    <div class="d-flex justify-content-between mb-2 small">
                                        <span class="text-secondary">Shipping</span>
                                        <span class="fw-medium"><%= shipping.cost > 0 ? locationData.symbol + shipping.cost.toLocaleString(undefined, { minimumFractionDigits: 2 }) : 'Free' %></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-7">
            <div class="d-flex align-items-center mb-4">
                <a href="/cart" class="btn btn-icon btn-light rounded-circle me-3">
                    <i class="bi bi-arrow-left"></i>
                </a>
                <div>
                    <h1 class="h3 fw-bold mb-0">Checkout</h1>
                    <% if (!currentUser) { %>
                        <p class="text-body-secondary small mb-0">
                            Already have an account? <a href="/users/login?redirect=/checkout" class="text-dark fw-bold text-decoration-underline">Log in</a> for faster checkout.
                        </p>
                    <% } else { %>
                         <p class="text-body-secondary small mb-0">Logged in as <span class="fw-medium text-dark"><%= currentUser.email %></span></p>
                    <% } %>
                </div>
            </div>

            <form action="/checkout/place-order" method="POST" id="checkout-form">
                
                <% if (!currentUser) { %>
                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                        <div class="card-body p-4">
                            <h5 class="fw-bold mb-3">Contact Information</h5>
                            <div class="form-floating">
                                <input type="email" class="form-control bg-light border-0" id="email" name="email" placeholder="name@example.com" required>
                                <label for="email">Email address</label>
                            </div>
                        </div>
                    </div>
                <% } else { %>
                    <input type="hidden" name="email" value="<%= currentUser.email %>">
                <% } %>

                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Delivery Method</h5>
                        <div class="row g-3">
                            <div class="col-6">
                                <label class="selection-card w-100">
                                    <input type="radio" name="delivery-method" value="ship" class="btn-check" checked>
                                    <div class="p-3 rounded-3 border text-center selection-content transition-all">
                                        <i class="bi bi-truck fs-4 mb-2 d-block"></i>
                                        <span class="fw-bold small">Ship to Address</span>
                                    </div>
                                </label>
                            </div>
                            <div class="col-6">
                                <label class="selection-card w-100">
                                    <input type="radio" name="delivery-method" value="pickup" class="btn-check">
                                    <div class="p-3 rounded-3 border text-center selection-content transition-all">
                                        <i class="bi bi-shop fs-4 mb-2 d-block"></i>
                                        <span class="fw-bold small">Pick Up</span>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="shipping-section" class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Shipping Address</h5>
                        
                        <% if (currentUser && addresses && addresses.length > 0) { %>
                            <div class="address-grid mb-4">
                                <% addresses.forEach((addr, index) => { %>
                                    <label class="address-card w-100 mb-2">
                                        <input type="radio" name="selectedAddressId" value="<%= addr.addressId %>" class="btn-check" <%= (addr.isDefault || (!addresses.some(a => a.isDefault) && index === 0)) ? 'checked' : '' %>>
                                        <div class="p-3 rounded-3 border selection-content d-flex align-items-center justify-content-between transition-all">
                                            <div>
                                                <div class="fw-bold"><%= addr.firstName %> <%= addr.lastName %></div>
                                                <div class="small text-secondary"><%= addr.address %>, <%= addr.state %></div>
                                            </div>
                                            <div class="check-icon bg-dark text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 20px; height: 20px; opacity: 0;">
                                                <i class="bi bi-check small"></i>
                                            </div>
                                        </div>
                                    </label>
                                <% }) %>
                                <label class="address-card w-100">
                                    <input type="radio" name="selectedAddressId" value="new" class="btn-check">
                                    <div class="p-3 rounded-3 border selection-content d-flex align-items-center gap-3 transition-all">
                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <i class="bi bi-plus-lg"></i>
                                        </div>
                                        <span class="fw-bold text-secondary">Use a different address</span>
                                    </div>
                                </label>
                            </div>
                        <% } %>
                        <fieldset id="shipping-address-fieldset" <%= (currentUser && addresses && addresses.length > 0) ? 'disabled' : '' %>>
                            <div class="row g-3">
                                <div class="col-6"><div class="form-floating"><input type="text" class="form-control bg-light border-0" id="firstName" name="firstName" placeholder="First" required><label for="firstName">First Name</label></div></div>
                                <div class="col-6"><div class="form-floating"><input type="text" class="form-control bg-light border-0" id="lastName" name="lastName" placeholder="Last" required><label for="lastName">Last Name</label></div></div>
                                <div class="col-12"><div class="form-floating"><input type="text" class="form-control bg-light border-0" id="address" name="address" placeholder="Address" required><label for="address">Street Address</label></div></div>
                                <div class="col-6"><div class="form-floating"><input type="text" class="form-control bg-light border-0" id="state" name="state" placeholder="State" required><label for="state">State/Province</label></div></div>
                                <div class="col-6"><div class="form-floating"><input type="text" class="form-control bg-light border-0" id="zip" name="zip" placeholder="Zip" required><label for="zip">Zip Code</label></div></div>
                                <div class="col-12"><div class="form-floating"><select class="form-select bg-light border-0" id="country" name="country" required><option value="Philippines">Philippines</option></select><label for="country">Country</label></div></div>
                                <div class="col-12"><div class="form-floating"><input type="tel" class="form-control bg-light border-0" id="phone" name="phone" placeholder="Phone" required><label for="phone">Phone Number</label></div></div>
                            </div>
                        </fieldset>
                        <% if (currentUser) { %>
                            <div class="form-check mt-3" id="save-address-container" <%= (addresses && addresses.length > 0) ? 'style="display:none;"' : '' %>>
                                <input class="form-check-input" type="checkbox" id="saveAddress" name="saveAddress">
                                <label class="form-check-label small text-secondary" for="saveAddress">Save this address to my profile</label>
                            </div>
                        <% } %>
                    </div>
                </div>
                
                <div id="pickup-form" class="card border-0 shadow-sm rounded-4 mb-4 d-none">
                     <div class="card-body p-4">
                        <h5 class="fw-bold mb-3">Store Pickup</h5>
                        <p class="text-secondary small mb-3">Select a store to pick up your order.</p>
                        <div class="form-floating mb-4">
                            <select class="form-select bg-light border-0" id="pickupStore" name="pickupStore">
                                <option value="" selected disabled>Select a store location</option>
                                <% if (typeof stores !== 'undefined' && stores.length > 0) { %>
                                    <% stores.forEach(store => { %>
                                        <option value="<%= store.id %>"><%= store.name %> (<%= store.city %>)</option>
                                    <% }) %>
                                <% } %>
                            </select>
                            <label for="pickupStore">Location</label>
                        </div>

                        <h6 class="fw-bold mb-3">Pickup Contact Person</h6>
                        <div class="row g-3">
                             <div class="col-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control bg-light border-0" id="pickupFirstName" name="pickupFirstName" placeholder="First">
                                    <label>First Name</label>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="form-floating">
                                    <input type="text" class="form-control bg-light border-0" id="pickupLastName" name="pickupLastName" placeholder="Last">
                                    <label>Last Name</label>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="form-floating">
                                    <input type="tel" class="form-control bg-light border-0" id="pickupPhone" name="pickupPhone" placeholder="Phone">
                                    <label>Phone Number</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="billing-section">
                    <div class="card border-0 shadow-sm rounded-4 mb-4">
                        <div class="card-body p-4">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sameAsShipping" name="sameAsShipping" checked>
                                <label class="form-check-label fw-medium" for="sameAsShipping">
                                    Billing address is the same as shipping/pickup
                                </label>
                            </div>
                            
                            <div id="billing-address-form" class="d-none mt-4 pt-3 border-top">
                                <h6 class="fw-bold mb-3">Billing Address</h6>
                                <div class="form-floating mb-3">
                                    <input type="text" class="form-control bg-light border-0" name="billing-address" id="billing-address" placeholder="Address">
                                    <label for="billing-address">Billing Address</label>
                                </div>
                                 <div class="row g-3">
                                     <div class="col-6">
                                         <div class="form-floating">
                                             <input type="text" class="form-control bg-light border-0" name="billing-state" placeholder="State">
                                            <label>State</label>
                                         </div>
                                     </div>
                                     <div class="col-6">
                                         <div class="form-floating">
                                              <input type="text" class="form-control bg-light border-0" name="billing-zip" placeholder="Zip">
                                            <label>Zip</label>
                                         </div>
                                     </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm rounded-4 mb-4">
                    <div class="card-body p-4">
                         <h5 class="fw-bold mb-3">Payment</h5>
                        <div class="row g-3">
                            <div class="col-6"><label class="selection-card w-100 h-100"><input type="radio" name="payment-method" value="cod" class="btn-check" checked><div class="p-3 rounded-3 border text-center selection-content transition-all h-100 d-flex flex-column align-items-center justify-content-center"><i class="bi bi-cash-stack fs-4 mb-2 d-block text-success"></i><span class="fw-bold small">Cash / Pay in Store</span></div></label></div>
                            <div class="col-6"><label class="selection-card w-100 h-100"><input type="radio" name="payment-method" value="cc" class="btn-check"><div class="p-3 rounded-3 border text-center selection-content transition-all h-100 d-flex flex-column align-items-center justify-content-center"><i class="bi bi-credit-card fs-4 mb-2 d-block text-primary"></i><span class="fw-bold small">Credit/Debit</span></div></label></div>
                            
                            <div class="col-12"><label class="selection-card w-100 h-100"><input type="radio" name="payment-method" value="nfc" class="btn-check"><div class="p-3 rounded-3 border text-center selection-content transition-all h-100 d-flex flex-row align-items-center justify-content-center gap-2"><i class="bi bi-broadcast fs-4 text-warning"></i><span class="fw-bold small">Tap to Pay / NFC</span></div></label></div>

                            <div class="col-4"><label class="selection-card w-100 h-100"><input type="radio" name="payment-method" value="gcash" class="btn-check"><div class="p-3 rounded-3 border text-center selection-content transition-all h-100 d-flex flex-column align-items-center justify-content-center"><i class="bi bi-wallet2 fs-5 mb-1 d-block text-primary"></i><span class="fw-bold small" style="font-size: 0.75rem;">GCash</span></div></label></div>
                            <div class="col-4"><label class="selection-card w-100 h-100"><input type="radio" name="payment-method" value="grabpay" class="btn-check"><div class="p-3 rounded-3 border text-center selection-content transition-all h-100 d-flex flex-column align-items-center justify-content-center"><i class="bi bi-phone fs-5 mb-1 d-block text-success"></i><span class="fw-bold small" style="font-size: 0.75rem;">GrabPay</span></div></label></div>
                            <div class="col-4"><label class="selection-card w-100 h-100"><input type="radio" name="payment-method" value="paypal" class="btn-check"><div class="p-3 rounded-3 border text-center selection-content transition-all h-100 d-flex flex-column align-items-center justify-content-center"><i class="bi bi-paypal fs-5 mb-1 d-block text-info"></i><span class="fw-bold small" style="font-size: 0.75rem;">PayPal</span></div></label></div>
                            
                            <div class="col-12"><label class="selection-card w-100 h-100"><input type="radio" name="payment-method" value="financing" class="btn-check"><div class="p-3 rounded-3 border text-center selection-content transition-all h-100 d-flex flex-row align-items-center justify-content-center gap-3"><i class="bi bi-pie-chart-fill fs-4 text-info"></i><span class="fw-bold small">Installments / Buy Now, Pay Later</span></div></label></div>
                        </div>

                        <div id="payment-details-cc" class="mt-4 d-none">
                            <div class="bg-light p-3 rounded-3">
                                <div class="form-floating mb-3"><input type="text" class="form-control border-0 bg-white" name="cc-number" placeholder="Card Number"><label>Card Number</label></div>
                                <div class="row g-3"><div class="col-6"><div class="form-floating"><input type="text" class="form-control border-0 bg-white" name="cc-expiration" placeholder="MM/YY"><label>Expiration</label></div></div><div class="col-6"><div class="form-floating"><input type="text" class="form-control border-0 bg-white" name="cc-cvv" placeholder="CVC"><label>CVC</label></div></div></div>
                            </div>
                        </div>

                        <div id="payment-details-financing" class="mt-4 d-none">
                            <div class="bg-light p-3 rounded-3">
                                <p class="fw-bold mb-2">Buy Now, Pay Later</p>
                                <div class="form-check mb-2">
                                    <input class="form-check-input" type="radio" name="financing-plan" id="plan-4" value="pay-in-4" checked>
                                    <label class="form-check-label small" for="plan-4">Pay in 4 interest-free payments</label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="financing-plan" id="plan-monthly" value="monthly">
                                    <label class="form-check-label small" for="plan-monthly">Monthly payments</label>
                                </div>
                            </div>
                        </div>

                        <div id="payment-details-nfc" class="mt-4 d-none text-center p-4 bg-light rounded-4">
                            <div class="row align-items-center">
                                <div class="col-md-5 mb-3 mb-md-0">
                                    <div class="bg-white p-2 rounded-3 shadow-sm d-inline-block">
                                        <img src="<%= nfcQrCode %>" alt="Scan QR" class="img-fluid" style="width: 140px;">
                                    </div>
                                </div>
                                <div class="col-md-7 text-md-start">
                                    <h5 class="fw-bold mb-2">Tap to Pay</h5>
                                    <p class="text-secondary small mb-3">
                                        <strong>Option A:</strong> Scan QR with another phone to pay.<br>
                                        <strong>Option B (Android):</strong> Click below and tap a physical NFC card.
                                    </p>
                                    
                                    <button type="button" class="btn btn-dark rounded-pill px-4 py-2 mb-2 d-none" id="real-nfc-btn" onclick="startNFCScan()">
                                        <i class="bi bi-wifi me-2"></i> Scan NFC Tag
                                    </button>

                                    <div id="nfc-status" class="text-primary fw-bold small mt-2">
                                        <span class="spinner-grow spinner-grow-sm me-2"></span> Waiting for connection...
                                    </div>
                                    <input type="hidden" id="nfc-transaction-id" value="<%= nfcTransactionId %>">
                                </div>
                            </div>
                        </div>

                        <div id="payment-details-cod" class="mt-3 text-center p-3 bg-light rounded-3"><p class="small text-secondary mb-0"><i class="bi bi-info-circle me-1"></i> You will pay in cash upon delivery/pickup.</p></div>
                        <div id="payment-details-redirect" class="mt-4 d-none text-center p-3 bg-light rounded-3">
                            <p class="small text-secondary mb-0"><i class="bi bi-box-arrow-up-right me-1"></i> You will be redirected to complete your payment securely.</p>
                        </div>
                    </div>
                </div>
                
                <button type="submit" id="place-order-btn" class="btn btn-dark btn-lg w-100 rounded-pill py-3 fw-bold shadow-sm">Place Order</button>
            </form>
        </div>

        <div class="col-lg-5 d-none d-lg-block">
            <div class="card border-0 shadow-sm rounded-4 summary-card-sticky" style="position: sticky; top: 100px;">
                <div class="card-body p-4">
                    <h4 class="fw-bold mb-4">Order Summary</h4>
                    
                    <div class="mb-4">
                        <label class="form-label small fw-bold text-secondary text-uppercase">Discount Code</label>
                        <div class="input-group mb-2">
                            <input type="text" id="voucher-code-desktop" class="form-control bg-light border-0" placeholder="Code">
                            <button class="btn btn-dark" type="button" onclick="applyVoucher('desktop')">Apply</button>
                        </div>
                        
                        <button type="button" class="btn btn-outline-secondary w-100 py-3 d-flex justify-content-between align-items-center" data-bs-toggle="modal" data-bs-target="#voucherWalletModal">
                            <span class="fw-medium"><i class="bi bi-ticket-perforated me-2"></i> Select from Wallet</span>
                            <% if (availableVouchers && availableVouchers.length > 0) { %>
                                <span class="badge bg-dark rounded-pill"><%= availableVouchers.length %></span>
                            <% } %>
                        </button>

                        <div id="voucher-message-desktop" class="mt-2 small"></div>

                        <% if (typeof appliedVoucher !== 'undefined' && appliedVoucher) { %>
                            <div class="alert alert-success mt-3 py-2 small d-flex justify-content-between align-items-center rounded-3 border-0 bg-success-subtle text-success-emphasis mb-0">
                                <span><i class="bi bi-check-circle-fill me-1"></i> Applied: <strong><%= appliedVoucher.code %></strong></span>
                                <span class="fw-bold">-<%= locationData.symbol %><%= discountAmount.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                            </div>
                            <div class="text-end mt-1">
                                <button onclick="removeVoucher()" class="btn btn-link text-danger p-0 small text-decoration-none">Remove Voucher</button>
                            </div>
                        <% } %>
                    </div>

                    <% if (shipping.amountNeeded > 0) { %>
                        <div class="mb-4">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <small class="text-body-secondary">Add <strong><%= locationData.symbol %><%= shipping.amountNeeded.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></strong> for free shipping</small>
                                <small class="fw-bold"><%= parseInt(shipping.progress) %>%</small>
                            </div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-dark" role="progressbar" style="width: <%= shipping.progress %>%;"></div>
                            </div>
                        </div>
                    <% } else { %>
                        <div class="mb-4 p-2 bg-success-subtle text-success rounded-3 text-center small fw-bold">
                            <i class="bi bi-check-circle-fill me-1"></i> You have qualified for Free Shipping!
                        </div>
                    <% } %>

                    <div class="cart-items-preview mb-4 p-3" style="max-height: 250px; overflow-y: auto;">
                        <% cart.items.forEach(item => { %>
                            <div class="d-flex gap-3 mb-3 align-items-center">
                                <div class="position-relative me-2">
                                    <img src="<%= item.thumbnailUrl %>" alt="<%= item.name %>" class="rounded-3 border bg-white" style="width: 64px; height: 64px; object-fit: contain;">
                                    <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-secondary border border-light" style="font-size: 0.65rem; z-index: 2;"><%= item.qty %></span>
                                </div>
                                <div class="flex-grow-1 min-w-0">
                                    <h6 class="fw-medium mb-0 text-dark small text-truncate" style="max-width: 200px;"><%= item.name %></h6>
                                     <small class="text-secondary"><%= item.brand %></small>
                                </div>
                                <span class="fw-semibold small"><%= locationData.symbol %><%= item.convertedPrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                            </div>
                        <% }) %>
                    </div>

                    <div class="bg-light rounded-3 p-3 mb-4 d-flex align-items-center gap-3">
                         <i class="bi bi-box-seam fs-4 text-secondary"></i>
                        <div>
                            <small class="text-secondary d-block text-uppercase fw-bold" style="font-size: 0.7rem;">Estimated Arrival</small>
                            <span class="fw-medium text-dark small"><%= arrivalDate %></span>
                        </div>
                    </div>

                    <div class="d-flex justify-content-between mb-2">
                        <span class="text-secondary">Subtotal</span>
                        <span class="fw-medium"><%= locationData.symbol %><%= cart.convertedTotalPrice.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                    </div>
                    <% if (typeof discountAmount !== 'undefined' && discountAmount > 0) { %>
                        <div class="d-flex justify-content-between mb-2 text-success">
                            <span>Discount</span>
                            <span class="fw-medium">-<%= locationData.symbol %><%= discountAmount.toLocaleString(undefined, { minimumFractionDigits: 2 }) %></span>
                        </div>
                    <% } %>
                    <div class="d-flex justify-content-between mb-3">
                        <span class="text-secondary">Shipping</span>
                        <span class="fw-medium" id="shipping-cost-display"><%= shipping.cost > 0 ? locationData.symbol + shipping.cost.toLocaleString(undefined, { minimumFractionDigits: 2 }) : 'Free' %></span>
                    </div>

                    <hr class="border-secondary-subtle">

                    <div class="d-flex justify-content-between align-items-center">
                        <span class="fw-bold fs-5">Total</span>
                        <div class="text-end">
                            <span class="fw-bold fs-4"><%= locationData.symbol %><%= totalWithShipping.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %></span>
                            <% if (locationData.currency !== 'USD') { %>
                                <br>
                                <small class="text-body-secondary" style="font-size: 0.75rem;">
                                    USD <%= (cart.totalPrice + (shipping.cost > 0 ? 5 : 0)).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 }) %>
                                </small>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="voucherWalletModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content rounded-4 border-0 shadow-lg">
            <div class="modal-header border-bottom-0 pb-0">
                <h5 class="modal-title fw-bold">Your Wallet</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-3">
                <% if (availableVouchers && availableVouchers.length > 0) { %>
                    <div class="list-group list-group-flush gap-2">
                        <% availableVouchers.forEach(v => { 
                            const isApplied = (typeof appliedVoucher !== 'undefined' && appliedVoucher && appliedVoucher.code === v.code);
                        %>
                            <div class="list-group-item border rounded-3 p-3 d-flex justify-content-between align-items-center <%= isApplied ? 'bg-success-subtle border-success-subtle' : 'bg-white' %>">
                                <div>
                                    <div class="d-flex align-items-center gap-2">
                                        <span class="badge <%= isApplied ? 'bg-success' : 'bg-dark' %>"><%= v.code %></span>
                                        <% if (isApplied) { %><span class="badge bg-white text-success border border-success"><i class="bi bi-check"></i> Applied</span><% } %>
                                    </div>
                                    <div class="fw-bold mt-2" style="font-size: 1.1rem;">
                                        <%= v.discountType === 'percentage' ? v.discountValue + '%' : '$' + v.discountValue %> OFF
                                    </div>
                                    <small class="text-body-secondary d-block">Min. Spend $<%= v.minOrderAmount %></small>
                                    <small class="text-body-tertiary" style="font-size: 0.75rem;">Expires: <%= new Date(v.expiryDate).toLocaleDateString() %></small>
                                </div>
                                <% if (isApplied) { %>
                                    <button class="btn btn-sm btn-outline-danger rounded-pill fw-bold px-3" onclick="removeVoucher()">
                                          Remove
                                    </button>
                                <% } else { %>
                                    <button class="btn btn-sm btn-dark rounded-pill fw-bold px-3 apply-wallet-voucher" data-code="<%= v.code %>">
                                        Apply
                                     </button>
                                <% } %>
                            </div>
                       <% }) %>
                    </div>
                <% } else { %>
                    <div class="text-center py-5">
                        <div class="bg-light rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 64px; height: 64px;">
                            <i class="bi bi-ticket-perforated text-secondary fs-3"></i>
                        </div>
                        <h6 class="fw-bold">No vouchers found</h6>
                        <p class="text-secondary small mb-0">You don't have any active coupons at the moment.</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<style>
    .checkout-page-wrapper { padding-top: 1rem; }
    .btn-icon { width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; border: 1px solid var(--border-color); transition: all 0.2s ease; }
    .btn-check:checked + .selection-content { background-color: #f8f9fa; border-color: #111 !important; box-shadow: 0 0 0 1px #111; }
    .btn-check:checked + .selection-content .check-icon { opacity: 1 !important; }
    .transition-all { transition: all 0.2s ease; }
    .form-floating > .form-control:focus ~ label { color: #111; }
    .form-floating > .form-control:focus { box-shadow: 0 0 0 2px rgba(0,0,0,0.1); }
</style>

<script src="/socket.io/socket.io.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- ADDRESS PRE-FILL LOGIC ---
        const addresses = <%- JSON.stringify(addresses || []) %>;
        const addressRadios = document.querySelectorAll('input[name="selectedAddressId"]');
        const shippingFieldset = document.getElementById('shipping-address-fieldset');
        const saveAddressContainer = document.getElementById('save-address-container');
        
        const formFields = {
            firstName: document.getElementById('firstName'),
            lastName: document.getElementById('lastName'),
            address: document.getElementById('address'),
            state: document.getElementById('state'),
            zip: document.getElementById('zip'),
            country: document.getElementById('country'),
            phone: document.getElementById('phone')
        };

        function populateForm(address) {
            for (const key in formFields) {
                if (formFields.hasOwnProperty(key) && address.hasOwnProperty(key) && formFields[key]) {
                    formFields[key].value = address[key];
                }
            }
        }

        function clearForm() {
            for (const key in formFields) {
                if (formFields[key]) formFields[key].value = '';
            }
        }

        function toggleAddressForm(state) {
            if (state === 'disabled') {
                shippingFieldset.disabled = true;
                if(saveAddressContainer) saveAddressContainer.style.display = 'none';
            } else {
                shippingFieldset.disabled = false;
                if(saveAddressContainer) saveAddressContainer.style.display = 'block';
            }
        }

        if (addressRadios.length > 0) {
            addressRadios.forEach(radio => {
                radio.addEventListener('change', function() {
                    if (this.value === 'new') {
                        clearForm();
                        toggleAddressForm('enabled');
                    } else {
                        const selectedAddress = addresses.find(addr => addr.addressId === this.value);
                        if (selectedAddress) {
                            populateForm(selectedAddress);
                            toggleAddressForm('disabled');
                        }
                    }
                });
            });
            // Initialize form state
            const checked = document.querySelector('input[name="selectedAddressId"]:checked');
            if(checked && checked.value !== 'new') {
                 const addr = addresses.find(a => a.addressId === checked.value);
                 if(addr) { populateForm(addr); toggleAddressForm('disabled'); }
            } else {
                 toggleAddressForm('enabled');
            }
        }

        // --- DELIVERY METHOD TOGGLE ---
        const deliveryRadios = document.querySelectorAll('input[name="delivery-method"]');
        const shippingSection = document.getElementById('shipping-section');
        const pickupForm = document.getElementById('pickup-form');
        const billingCheck = document.getElementById('sameAsShipping');
        const billingSection = document.getElementById('billing-section');
        // Inputs for validation toggling
        const shippingInputs = document.querySelectorAll('#shipping-address-fieldset input, #shipping-address-fieldset select');
        const pickupInputs = document.querySelectorAll('#pickup-form input, #pickup-form select');

        const setRequired = (elements, required) => {
            elements.forEach(input => {
                input.required = required;
                if (elements === shippingInputs && shippingFieldset.disabled) {
                   input.required = false; 
                }
            });
        };
        const updateDeliveryMode = (mode) => {
            const usingSavedAddress = document.querySelector('input[name="selectedAddressId"]:checked')?.value !== 'new';
            const shippingCostDisplay = document.getElementById('shipping-cost-display');

            if (mode === 'ship') {
                shippingSection.classList.remove('d-none');
                pickupForm.classList.add('d-none');
                
                // Show Billing Section again
                billingSection.classList.remove('d-none');
                // Validation Logic
                setRequired(shippingInputs, !usingSavedAddress);
                setRequired(pickupInputs, false);
                
                // Update Summary
                if (shippingCostDisplay) shippingCostDisplay.innerText = "<%= shipping.cost > 0 ? locationData.symbol + shipping.cost.toLocaleString(undefined, { minimumFractionDigits: 2 }) : 'Free' %>";
            } else {
                // Pickup Mode
                shippingSection.classList.add('d-none');
                pickupForm.classList.remove('d-none');
                
                // Validation Logic
                setRequired(shippingInputs, false);
                setRequired(pickupInputs, true);
                
                // Force Billing to be "Same as Pickup"
                if(billingCheck) billingCheck.checked = true;
                billingSection.classList.add('d-none'); 

                // Update Summary
                if (shippingCostDisplay) shippingCostDisplay.innerText = "Free (Pickup)";
            }
        };

        deliveryRadios.forEach(radio => {
            radio.addEventListener('change', function() { updateDeliveryMode(this.value); });
        });
        // Init Delivery Mode
        const checkedDelivery = document.querySelector('input[name="delivery-method"]:checked');
        if(checkedDelivery) updateDeliveryMode(checkedDelivery.value);

        // --- PAYMENT METHOD TOGGLE (Enhanced with NFC & E-Wallets) ---
        const paymentRadios = document.querySelectorAll('input[name="payment-method"]');
        const details = {
            cc: document.getElementById('payment-details-cc'),
            financing: document.getElementById('payment-details-financing'),
            cod: document.getElementById('payment-details-cod'),
            nfc: document.getElementById('payment-details-nfc'),
            redirect: document.getElementById('payment-details-redirect')
        };
        const btn = document.getElementById('place-order-btn');
        const ccInputs = details.cc.querySelectorAll('input');

        paymentRadios.forEach(radio => {
            radio.addEventListener('change', function() {
                // Hide all details first
                Object.values(details).forEach(el => { if(el) el.classList.add('d-none'); });
                
                // Reset Button
                btn.disabled = false;
                btn.innerHTML = "Place Order";
                
                // Remove required attribute from CC
                ccInputs.forEach(input => input.required = false);

                // Show specific details
                if (this.value === 'cc') {
                    details.cc.classList.remove('d-none');
                    ccInputs.forEach(input => input.required = true);
                } else if (this.value === 'financing') {
                    details.financing.classList.remove('d-none');
                } else if (this.value === 'cod') {
                    details.cod.classList.remove('d-none');
                } else if (this.value === 'nfc') {
                    // NFC Specific Logic
                    details.nfc.classList.remove('d-none');
                    btn.disabled = true; // Disable until paid
                    btn.innerHTML = "Waiting for Tap...";
                    initNFCListener(); // Start Socket Listener
                } else if (['gcash', 'grabpay', 'paypal'].includes(this.value)) {
                    // E-Wallet Logic
                    details.redirect.classList.remove('d-none');
                    btn.innerHTML = `Pay with ${this.value.charAt(0).toUpperCase() + this.value.slice(1)}`;
                }
            });
        });

        // --- NFC LOGIC ---
        
        // Check Web NFC Support (Android Chrome)
        if ('NDEFReader' in window) {
            document.getElementById('real-nfc-btn').classList.remove('d-none');
        }

        // Real NFC Scan Function
        window.startNFCScan = async function() {
            const status = document.getElementById('nfc-status');
            status.textContent = "Scanning... Tap your card to back of device.";
            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                ndef.onreading = event => {
                    completeNFC(`NFC Tag Detected: ${event.serialNumber}`);
                };
            } catch (error) {
                status.textContent = "Error: " + error;
                status.className = "text-danger small mt-2";
            }
        };

        // Socket Listener (for QR/Cross-Device flow)
        let socket;
        function initNFCListener() {
            if(!socket) socket = io();
            const txId = document.getElementById('nfc-transaction-id').value;
            
            // Listen for the specific transaction event
            socket.off(`nfc-payment-success:${txId}`); // Avoid duplicate listeners
            socket.on(`nfc-payment-success:${txId}`, (data) => {
                if(data.success) {
                    completeNFC("Device Tapped Successfully via QR");
                }
            });
        }

        function completeNFC(msg) {
            const status = document.getElementById('nfc-status');
            status.innerHTML = `<i class="bi bi-check-circle-fill text-success me-2"></i> ${msg}`;
            status.className = "mt-2 text-success fw-bold small";
            
            // Inject verified token
            const form = document.getElementById('checkout-form');
            let input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'nfc-token';
            input.value = 'verified-token-' + Date.now();
            form.appendChild(input);
            
            // Auto submit
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = "Processing...";
                btn.click();
            }, 1000);
        }

        // --- BILLING TOGGLE ---
        const billingAddressForm = document.getElementById('billing-address-form');
        const billingInputs = billingAddressForm.querySelectorAll('input');
        if(billingCheck) {
            billingCheck.addEventListener('change', function() {
                if(this.checked) {
                    billingAddressForm.classList.add('d-none');
                    billingInputs.forEach(i => i.required = false);
                } else {
                    billingAddressForm.classList.remove('d-none');
                    // Only require billing inputs if form is visible
                    billingInputs.forEach(i => i.required = true);
                }
            });
        }

        // --- VOUCHER LOGIC ---
        window.applyVoucher = function(context) {
            const inputId = context === 'mobile' ? 'voucher-code-mobile' : 'voucher-code-desktop';
            const msgId = context === 'mobile' ? 'voucher-message-mobile' : 'voucher-message-desktop';
            const code = document.getElementById(inputId).value;
            const msgDiv = document.getElementById(msgId);
            
            if(!code) return;
            performApply(code, msgDiv);
        }

        window.removeVoucher = function() {
            fetch('/checkout/remove-voucher', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if(data.success) location.reload();
                });
        }

        function performApply(code, msgDivElement) {
            if(msgDivElement) msgDivElement.innerHTML = '<span class="text-body-secondary"><i class="bi bi-hourglass-split"></i> Applying...</span>';
            fetch('/checkout/apply-voucher', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ code: code })
            })
            .then(res => res.json())
            .then(data => {
                if(data.success) {
                    location.reload(); 
                } else {
                     if(msgDivElement) msgDivElement.innerHTML = `<span class="text-danger"><i class="bi bi-exclamation-circle me-1"></i> ${data.message}</span>`;
                }
            })
            .catch(err => {
                console.error(err);
                 if(msgDivElement) msgDivElement.innerHTML = `<span class="text-danger">Error applying voucher.</span>`;
            });
        }

        document.querySelectorAll('.apply-wallet-voucher').forEach(btn => {
            btn.addEventListener('click', function() {
                const isMobile = window.innerWidth < 992;
                const msgDiv = document.getElementById(isMobile ? 'voucher-message-mobile' : 'voucher-message-desktop');
                
                performApply(this.dataset.code, msgDiv);
                
                const modalEl = document.getElementById('voucherWalletModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                if(modal) modal.hide();
            });
        });
    });
</script>