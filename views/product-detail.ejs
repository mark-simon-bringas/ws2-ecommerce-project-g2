<div class="container my-5 product-detail-page">
    <div class="row">
        <div class="col-lg-7">
            <div class="product-image-container">
                <% if (product.imageUrl) { %>
                    <img src="<%= product.imageUrl %>" alt="<%= product.name %>" class="img-fluid">
                <% } else { %>
                    <img src="https://via.placeholder.com/800x800.png?text=No+Image" alt="No Image Available" class="img-fluid">
                <% } %>
            </div>
        </div>

        <div class="col-lg-5">
            <div class="product-info-panel">
                <p class="text-body-secondary mb-2"><%= product.brand %></p>
                <h1 class="product-title display-5 fw-bold"><%= product.name %></h1>
                <p class="product-price h3 my-3">$<%= product.retailPrice %></p>
                
                <hr>
                
                <form id="add-to-cart-form" action="/cart/add" method="POST" class="d-grid gap-3">
                    <input type="hidden" name="productId" value="<%= product._id %>">
                    <input type="hidden" name="sku" value="<%= product.sku %>">

                    <div class="mb-2">
                        <label class="form-label d-flex justify-content-between">
                            <strong>Select Size</strong>
                            <a href="#" class="small text-body-secondary">Size Guide</a>
                        </label>
                        <div class="size-selector">
                            <% ['8', '8.5', '9', '9.5', '10', '10.5', '11', '12'].forEach(size => { %>
                                <input type="radio" class="btn-check" name="size" id="size-<%= size %>" value="<%= size %>" autocomplete="off" required>
                                <label class="btn btn-outline-secondary" for="size-<%= size %>"><%= size %></label>
                            <% }) %>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary btn-lg">Add to Bag</button>
                </form>

                <div class="d-grid mt-3">
                    <% if (currentUser) { %>
                        <form id="wishlist-toggle-form">
                            <input type="hidden" name="productId" value="<%= product._id %>">
                            <button type="submit" class="btn btn-outline-secondary btn-lg d-flex align-items-center justify-content-center gap-2">
                                <span><%- isWishlisted ? 'In Favorites' : 'Favorite' %></span>
                                <i class="bi <%- isWishlisted ? 'bi-heart-fill' : 'bi-heart' %>"></i>
                            </button>
                        </form>
                    <% } else { %>
                        <a href="/users/login" class="btn btn-outline-secondary btn-lg d-flex align-items-center justify-content-center gap-2">
                            <span>Favorite</span>
                            <i class="bi bi-heart"></i>
                        </a>
                    <% } %>
                </div>

                <div class="product-feature-highlights mt-5">
                    <div class="feature-item">
                        <i class="bi bi-box-seam"></i>
                        <p>Free Shipping & Returns</p>
                    </div>
                    <div class="feature-item">
                        <i class="bi bi-patch-check"></i>
                        <p>Authenticity Guaranteed</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5 pt-5">
        <div class="col-12">
            <div class="accordion product-details-accordion" id="productDetailsAccordion">
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDescription" aria-expanded="true" aria-controls="collapseDescription">
                            Description
                        </button>
                    </h2>
                    <div id="collapseDescription" class="accordion-collapse collapse show" data-bs-parent="#productDetailsAccordion">
                        <div class="accordion-body">
                            A timeless classic, redesigned for modern comfort and style. The perfect addition to any collection, this sneaker combines premium materials with iconic design elements to deliver a shoe that's as versatile as it is stylish. Whether you're hitting the streets or the court, do it in style.
                        </div>
                    </div>
                </div>
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDetails" aria-expanded="false" aria-controls="collapseDetails">
                            Details
                        </button>
                    </h2>
                    <div id="collapseDetails" class="accordion-collapse collapse" data-bs-parent="#productDetailsAccordion">
                        <div class="accordion-body">
                            <ul class="list-unstyled">
                                <li><strong>SKU:</strong> <%= product.sku %></li>
                                <li><strong>Brand:</strong> <%= product.brand %></li>
                                <li><strong>Category:</strong> <%= product.gender.charAt(0).toUpperCase() + product.gender.slice(1) %></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-5 pt-5">
        <div class="col-12">
            <div class="reviews-section">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 class="h3 mb-0">Reviews</h2>
                    <% if (currentUser) { %>
                        <a href="/products/<%= product.sku %>/review" class="btn btn-primary">Write a Review</a>
                    <% } %>
                </div>

                <% if (reviews && reviews.length > 0) { %>
                    <div class="review-list">
                        <% reviews.forEach(review => { %>
                            <div class="review-card">
                                <div class="review-header">
                                    <div class="review-author"><%= review.author.firstName %></div>
                                    <div class="review-date"><%= new Date(review.createdAt).toLocaleDateString() %></div>
                                </div>
                                <div class="review-rating">
                                    <% for(let i = 1; i <= 5; i++) { %>
                                        <i class="bi <%= i <= review.rating ? 'bi-star-fill' : 'bi-star' %>"></i>
                                    <% } %>
                                </div>
                                <div class="review-body">
                                    <p><%= review.comment %></p>
                                </div>
                            </div>
                        <% }) %>
                    </div>
                <% } else { %>
                    <div class="text-center p-5 bg-light rounded-4">
                        <h4 class="text-body-secondary">No reviews yet.</h4>
                        <p class="lead text-body-secondary">Be the first to share your thoughts!</p>
                    </div>
                <% } %>
            </div>
        </div>
    </div>
</div>

<% if (currentUser) { %>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const wishlistForm = document.getElementById('wishlist-toggle-form');
        if (wishlistForm) {
            wishlistForm.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const productId = this.querySelector('input[name="productId"]').value;
                const button = this.querySelector('button');
                const buttonSpan = button.querySelector('span');
                const buttonIcon = button.querySelector('i');

                fetch('/account/wishlist/toggle', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ productId: productId })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Toggle button state based on the new status from the server
                        if (data.newStatus === 'added') {
                            buttonSpan.textContent = 'In Favorites';
                            buttonIcon.classList.remove('bi-heart');
                            buttonIcon.classList.add('bi-heart-fill');
                        } else { // 'removed'
                            buttonSpan.textContent = 'Favorite';
                            buttonIcon.classList.remove('bi-heart-fill');
                            buttonIcon.classList.add('bi-heart');
                        }
                    } else {
                        alert(data.message || 'Could not update wishlist.');
                    }
                })
                .catch(error => {
                    console.error('Wishlist Error:', error);
                    alert('An error occurred. Please try again.');
                });
            });
        }
    });
</script>
<% } %>